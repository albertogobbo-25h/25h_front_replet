# üì± API Cliente Plano - Frontend

Documenta√ß√£o das fun√ß√µes p√∫blicas para integra√ß√£o com frontend.

---

## üéØ Fun√ß√µes Dispon√≠veis

### 1. Criar Plano
```typescript
// POST: rpc/criar_cliente_plano
{
  p_nome: string;           // obrigat√≥rio
  p_tipo: 'VALOR_FIXO' | 'PACOTE' | 'VALOR_VARIAVEL';  // obrigat√≥rio
  p_descricao?: string;
  p_valor_mensal?: number;
  p_valor_atendimento?: number;
  p_qtd_atendimentos?: number;
  p_periodicidade?: 'MENSAL' | 'TRIMESTRAL' | 'SEMESTRAL' | 'ANUAL';
}

// Retorno
{
  status: 'OK' | 'ERROR';
  message: string;
  plano_id?: string;
  code?: string;  // c√≥digo do erro
}
```

**Valida√ß√µes por tipo:**
- `VALOR_FIXO`: requer `valor_mensal` e `periodicidade`
- `PACOTE`: requer `valor_mensal` e `qtd_atendimentos`
- `VALOR_VARIAVEL`: requer `valor_atendimento` e `periodicidade`

---

### 2. Listar Planos
```typescript
// POST: rpc/listar_cliente_planos
{
  p_nome?: string;          // busca parcial (ILIKE)
  p_tipo?: 'VALOR_FIXO' | 'PACOTE' | 'VALOR_VARIAVEL';
  p_ativo?: boolean;
  p_limit?: number;         // default: 100, max: 1000
  p_offset?: number;        // default: 0
}

// Retorno (array)
[{
  id: string;
  nome: string;
  descricao: string | null;
  tipo: string;
  valor_mensal: number | null;
  valor_atendimento: number | null;
  qtd_atendimentos: number | null;
  periodicidade: string | null;
  ativo: boolean;
  criado_em: string;
  modificado_em: string;
}]
```

---

### 3. Obter Plano Espec√≠fico
```typescript
// POST: rpc/obter_cliente_plano
{
  p_plano_id: string;  // obrigat√≥rio
}

// Retorno
{
  status: 'OK' | 'ERROR';
  message: string;
  plano_id: string;
  data?: {
    id: string;
    nome: string;
    descricao: string | null;
    tipo: string;
    valor_mensal: number | null;
    valor_atendimento: number | null;
    qtd_atendimentos: number | null;
    periodicidade: string | null;
    ativo: boolean;
    criado_em: string;
    modificado_em: string;
  };
  code?: string;
}
```

---

### 4. Atualizar Plano
```typescript
// POST: rpc/atualizar_cliente_plano
{
  p_plano_id: string;       // obrigat√≥rio
  p_nome?: string;
  p_descricao?: string;
  p_tipo?: 'VALOR_FIXO' | 'PACOTE' | 'VALOR_VARIAVEL';
  p_valor_mensal?: number;
  p_valor_atendimento?: number;
  p_qtd_atendimentos?: number;
  p_periodicidade?: 'MENSAL' | 'TRIMESTRAL' | 'SEMESTRAL' | 'ANUAL';
}

// Retorno
{
  status: 'OK' | 'ERROR';
  message: string;
  plano_id?: string;
  code?: string;
}
```

**Nota:** Atualiza√ß√£o parcial - apenas campos fornecidos s√£o alterados.

---

### 5. Desativar Plano
```typescript
// POST: rpc/desativar_cliente_plano
{
  p_plano_id: string;  // obrigat√≥rio
}

// Retorno
{
  status: 'OK' | 'ERROR';
  message: string;
  plano_id?: string;
  code?: string;
}
```

---

### 6. Reativar Plano
```typescript
// POST: rpc/reativar_cliente_plano
{
  p_plano_id: string;  // obrigat√≥rio
}

// Retorno
{
  status: 'OK' | 'ERROR';
  message: string;
  plano_id?: string;
  code?: string;
}
```

---

### 7. Excluir Plano
```typescript
// POST: rpc/excluir_cliente_plano
{
  p_plano_id: string;  // obrigat√≥rio
}

// Retorno
{
  status: 'OK' | 'ERROR';
  message: string;
  plano_id?: string;
  code?: string;
}
```

**‚ö†Ô∏è Aten√ß√£o:** N√£o √© poss√≠vel excluir planos com assinaturas ativas. Nesse caso, use `desativar_cliente_plano`.

---

## üìã Tipos de Plano

| Tipo | Descri√ß√£o | Campos Obrigat√≥rios |
|------|-----------|---------------------|
| **VALOR_FIXO** | Cobran√ßa peri√≥dica com valor fixo (ex: mensalidade) | `valor_mensal`, `periodicidade` |
| **PACOTE** | Pacote pr√©-pago de atendimentos (n√£o recorrente) | `valor_mensal`, `qtd_atendimentos` |
| **VALOR_VARIAVEL** | Cobran√ßa peri√≥dica baseada em uso | `valor_atendimento`, `periodicidade` |

---

## üîí Seguran√ßa

- Todas as fun√ß√µes requerem autentica√ß√£o (`authenticated`)
- RLS garante que usu√°rios vejam apenas planos do pr√≥prio assinante
- Valida√ß√µes de propriedade em todas as opera√ß√µes

---

## üö® C√≥digos de Erro Comuns

| C√≥digo | Descri√ß√£o |
|--------|-----------|
| `UNAUTHORIZED` | Usu√°rio n√£o autenticado |
| `USER_NOT_FOUND` | Usu√°rio sem assinante vinculado |
| `PLANO_NAO_ENCONTRADO` | Plano n√£o existe |
| `PLANO_NAO_PERTENCE_ASSINANTE` | Plano pertence a outro assinante |
| `NOME_OBRIGATORIO` | Nome n√£o fornecido |
| `TIPO_OBRIGATORIO` | Tipo n√£o fornecido |
| `VALOR_MENSAL_OBRIGATORIO` | Valor mensal necess√°rio para tipo escolhido |
| `PERIODICIDADE_OBRIGATORIA` | Periodicidade necess√°ria para tipo escolhido |
| `VALOR_ATENDIMENTO_OBRIGATORIO` | Valor por atendimento necess√°rio |
| `QTD_ATENDIMENTOS_OBRIGATORIA` | Quantidade de atendimentos necess√°ria |
| `PLANO_COM_ASSINATURAS_ATIVAS` | N√£o pode excluir plano em uso |
| `PLANO_JA_DESATIVADO` | Plano j√° est√° desativado |
| `PLANO_JA_ATIVO` | Plano j√° est√° ativo |

---

## üí° Exemplo de Uso (JavaScript/TypeScript)

```typescript
import { createClient } from '@supabase/supabase-js';

const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// Criar plano
const { data, error } = await supabase.rpc('criar_cliente_plano', {
  p_nome: 'Plano Mensal',
  p_tipo: 'VALOR_FIXO',
  p_descricao: 'Plano com mensalidade fixa',
  p_valor_mensal: 150.00,
  p_periodicidade: 'MENSAL'
});

if (data.status === 'OK') {
  console.log('Plano criado:', data.plano_id);
} else {
  console.error('Erro:', data.message);
}

// Listar planos ativos
const { data: planos } = await supabase.rpc('listar_cliente_planos', {
  p_ativo: true,
  p_limit: 50
});
```

---

**√öltima atualiza√ß√£o:** Outubro 2025

