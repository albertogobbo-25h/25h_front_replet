# APIs P√∫blicas SEM Autentica√ß√£o - Links de Assinatura e Pagamento

> Documenta√ß√£o para frontend implementar p√°ginas p√∫blicas de assinatura e pagamento.

---

## üìã Vis√£o Geral

Estas APIs permitem que **clientes finais n√£o logados** realizem assinaturas e visualizem cobran√ßas atrav√©s de links p√∫blicos.

**Caracter√≠sticas:**
- ‚ùå N√£o requer autentica√ß√£o
- ‚úÖ Acess√≠vel com cliente `anon`
- ‚úÖ Valida√ß√µes de seguran√ßa via UUIDs imprevis√≠veis

---

## üîó URLs dos Links P√∫blicos

### Link Tipo 1: Formul√°rio de Assinatura
```
/publico/assinar/{plano_id}
```

**Par√¢metros da URL:**
| Par√¢metro | Descri√ß√£o | Onde obter |
|-----------|-----------|------------|
| `plano_id` | UUID do plano | Gerado pelo assinante no painel |

**Exemplo:**
```
https://app.25h.com.br/publico/assinar/019adf1a-5a64-716f-972d-63183f9bc902
```

---

### Link Tipo 2: P√°gina de Pagamento
```
/publico/pagar/{cobranca_id}
```

**Par√¢metros da URL:**
| Par√¢metro | Descri√ß√£o | Onde obter |
|-----------|-----------|------------|
| `cobranca_id` | UUID da cobran√ßa | Retornado ao criar assinatura ou cobran√ßa |

**Exemplo:**
```
https://app.25h.com.br/publico/pagar/019bcd12-3456-789a-bcde-f0123456789a
```

---

## üì¶ Padr√£o de Resposta

```typescript
interface ApiResponse<T> {
  status: 'OK' | 'ERROR' | 'WARNING'
  message: string
  code?: string      // Apenas em erros/warnings
  data?: T           // Dados da resposta
}
```

---

## üîß Fun√ß√µes Dispon√≠veis

### 1. `obter_plano_para_assinatura_sem_auth`

**Quando usar:** Ao carregar a p√°gina `/publico/assinar/{plano_id}` para exibir informa√ß√µes do plano.

```typescript
// Extrair plano_id da URL
const planoId = router.query.plano_id // ou useParams()

const { data: result } = await supabase.rpc('obter_plano_para_assinatura_sem_auth', {
  p_cliente_plano_id: planoId
})
```

**Resposta sucesso:**
```json
{
  "status": "OK",
  "message": "Plano encontrado.",
  "data": {
    "plano": {
      "id": "019adf1a-...",
      "nome": "Plano Mensal",
      "descricao": "Aulas semanais",
      "tipo": "VALOR_FIXO",
      "valor_mensal": 150.00,
      "periodicidade": "MENSAL"
    },
    "assinante": {
      "id": "a3f096d3-...",
      "nome": "Academia XYZ",
      "nome_fantasia": "XYZ Fitness",
      "whatsapp": "11999998888",
      "email": "contato@xyz.com"
    }
  }
}
```

**Erros poss√≠veis:**
| C√≥digo | Descri√ß√£o |
|--------|-----------|
| `PLANO_NAO_ENCONTRADO` | Link inv√°lido ou plano exclu√≠do |
| `PLANO_INATIVO` | Plano foi desativado |
| `ASSINANTE_NAO_ENCONTRADO` | Assinante n√£o existe |

---

### 2. `buscar_cliente_por_cpf_cnpj_sem_auth`

**Quando usar:** Enquanto usu√°rio digita CPF/CNPJ no formul√°rio, para pr√©-preencher dados se cliente j√° existir.

```typescript
// Chamar quando CPF/CNPJ tiver 11 ou 14 d√≠gitos
const cpfCnpj = '12345678900' // Apenas n√∫meros

// Obter assinante_id do resultado de obter_plano_para_assinatura_sem_auth
const assinanteId = planoData.assinante.id

const { data: result } = await supabase.rpc('buscar_cliente_por_cpf_cnpj_sem_auth', {
  p_assinante_id: assinanteId,
  p_cpf_cnpj: cpfCnpj
})
```

**Resposta - Cliente N√ÉO encontrado:**
```json
{
  "status": "OK",
  "message": "Cliente n√£o encontrado.",
  "data": {
    "encontrado": false,
    "cliente": null
  }
}
```

**Resposta - Cliente encontrado:**
```json
{
  "status": "OK",
  "message": "Cliente encontrado.",
  "data": {
    "encontrado": true,
    "cliente": {
      "id": "uuid",
      "nome": "Jo√£o Silva",
      "whatsapp": "11987654321",
      "email": "joao@email.com",
      "cpf_cnpj": "12345678900",
      "tipo_pessoa": "FISICA",
      "rua": "Rua das Flores",
      "numero": "123",
      "bairro": "Centro",
      "cidade": "S√£o Paulo",
      "uf": "SP",
      "cep": "01234567",
      "ind_ativo": true
    }
  }
}
```

**Uso t√≠pico no formul√°rio:**
```typescript
// Debounce de 500ms ao digitar CPF/CNPJ
const handleCpfCnpjChange = debounce(async (value) => {
  const cpfLimpo = value.replace(/\D/g, '')
  
  if (cpfLimpo.length === 11 || cpfLimpo.length === 14) {
    const { data } = await supabase.rpc('buscar_cliente_por_cpf_cnpj_sem_auth', {
      p_assinante_id: assinanteId,
      p_cpf_cnpj: cpfLimpo
    })
    
    if (data?.data?.encontrado) {
      // Pr√©-preencher formul√°rio
      setFormData(data.data.cliente)
      setClienteExistente(true)
    }
  }
}, 500)
```

---

### 3. `criar_assinatura_sem_auth`

**Quando usar:** Ao submeter o formul√°rio de assinatura.

```typescript
const dadosCliente = {
  nome: 'Jo√£o Silva',              // Obrigat√≥rio
  whatsapp: '11987654321',         // Obrigat√≥rio (apenas n√∫meros, 11 d√≠gitos)
  cpf_cnpj: '12345678900',         // Opcional
  tipo_pessoa: 'FISICA',           // FISICA ou JURIDICA (obrigat√≥rio se cpf_cnpj)
  email: 'joao@email.com',         // Opcional
  rua: 'Rua das Flores',           // Opcional
  numero: '123',                   // Opcional
  complemento: 'Apto 45',          // Opcional
  bairro: 'Centro',                // Opcional
  cidade: 'S√£o Paulo',             // Opcional
  uf: 'SP',                        // Opcional (2 letras)
  cep: '01234567'                  // Opcional (8 d√≠gitos)
}

const { data: result } = await supabase.rpc('criar_assinatura_sem_auth', {
  p_cliente_plano_id: planoId,
  p_dados_cliente: dadosCliente,
  p_confirmar_duplicacao: false
})
```

**Resposta sucesso:**
```json
{
  "status": "OK",
  "message": "Assinatura criada com sucesso!",
  "data": {
    "cliente_id": "uuid",
    "assinatura_id": "uuid",
    "cobranca_id": "uuid",
    "link_pagamento": "https://app.25h.com.br/publico/pagar/uuid",
    "valor_primeira_cobranca": 150.00,
    "data_vencimento": "2025-01-15",
    "plano": {
      "id": "uuid",
      "nome": "Plano Mensal",
      "valor_mensal": 150.00
    },
    "assinante": {
      "id": "uuid",
      "nome": "Academia XYZ"
    }
  }
}
```

**‚ö†Ô∏è Resposta WARNING - Assinatura Duplicada:**
```json
{
  "status": "WARNING",
  "code": "ASSINATURA_DUPLICADA",
  "message": "Voc√™ j√° possui uma assinatura ativa deste plano. Deseja criar outra?",
  "data": {
    "assinatura_existente_id": "uuid",
    "cliente_id": "uuid",
    "requer_confirmacao": true
  }
}
```

**Tratamento do WARNING:**
```typescript
if (result?.status === 'WARNING' && result?.code === 'ASSINATURA_DUPLICADA') {
  // Exibir modal de confirma√ß√£o
  const confirmar = await showConfirmDialog(
    'Assinatura Existente',
    'Voc√™ j√° possui uma assinatura ativa deste plano. Deseja criar outra mesmo assim?'
  )
  
  if (confirmar) {
    // Chamar novamente com confirma√ß√£o
    const { data: resultConfirmado } = await supabase.rpc('criar_assinatura_sem_auth', {
      p_cliente_plano_id: planoId,
      p_dados_cliente: dadosCliente,
      p_confirmar_duplicacao: true  // <-- Confirmar
    })
    
    if (resultConfirmado?.status === 'OK') {
      // Redirecionar para pagamento
      router.push(resultConfirmado.data.link_pagamento)
    }
  }
  return
}

if (result?.status === 'OK') {
  // Redirecionar para p√°gina de pagamento
  router.push(result.data.link_pagamento)
}
```

**Erros poss√≠veis:**
| C√≥digo | Descri√ß√£o |
|--------|-----------|
| `NOME_OBRIGATORIO` | Nome n√£o informado |
| `WHATSAPP_OBRIGATORIO` | WhatsApp n√£o informado |
| `INVALID_WHATSAPP` | Formato inv√°lido (use 11 d√≠gitos: DDD + 9 + n√∫mero) |
| `INVALID_EMAIL` | Email inv√°lido |
| `PLANO_NAO_ENCONTRADO` | Plano n√£o existe |
| `PLANO_INATIVO` | Plano foi desativado |
| `PLANO_SEM_VALOR` | Plano n√£o tem valor mensal configurado |

---

### 4. `consultar_cobranca_sem_auth`

**Quando usar:** Ao carregar a p√°gina `/publico/pagar/{cobranca_id}`.

```typescript
// Extrair cobranca_id da URL
const cobrancaId = router.query.cobranca_id

const { data: result } = await supabase.rpc('consultar_cobranca_sem_auth', {
  p_cobranca_id: cobrancaId
})
```

**Resposta sucesso:**
```json
{
  "status": "OK",
  "message": "Cobran√ßa encontrada.",
  "data": {
    "cobranca": {
      "id": "uuid",
      "descricao": "Plano Mensal - Aulas semanais",
      "valor_total": 150.00,
      "data_vencimento": "2025-01-15",
      "status_pagamento": "EM_ABERTO",
      "data_emissao": "2025-01-08",
      "vencida": false
    },
    "cliente": {
      "nome": "Jo√£o Silva",
      "nome_visualizacao": "Jo√£o",
      "cpf_cnpj": "123.456.789-00"
    },
    "plano": {
      "nome": "Plano Mensal",
      "descricao": "Aulas semanais",
      "periodicidade": "MENSAL"
    },
    "assinante": {
      "nome": "Academia XYZ",
      "whatsapp": "11999998888",
      "email": "contato@xyz.com"
    }
  }
}
```

**Erros poss√≠veis:**
| C√≥digo | Descri√ß√£o |
|--------|-----------|
| `COBRANCA_NAO_ENCONTRADA` | Link inv√°lido |
| `COBRANCA_JA_PAGA` | Cobran√ßa j√° foi paga |
| `COBRANCA_CANCELADA` | Cobran√ßa foi cancelada |

---

## üé® Fluxo Recomendado para o Frontend

### P√°gina de Assinatura (`/publico/assinar/[plano_id]`)

```
1. Extrair plano_id da URL
2. Chamar obter_plano_para_assinatura_sem_auth
   - Se erro ‚Üí Exibir "Link inv√°lido ou expirado"
   - Se OK ‚Üí Exibir dados do plano e formul√°rio

3. Formul√°rio com campos:
   - Nome* 
   - WhatsApp* (11 d√≠gitos)
   - CPF/CNPJ (ao digitar, chamar buscar_cliente_por_cpf_cnpj_sem_auth)
   - Email
   - Endere√ßo (opcional)

4. Se CPF encontrado ‚Üí Pr√©-preencher campos

5. Ao submeter ‚Üí criar_assinatura_sem_auth
   - Se WARNING ‚Üí Modal de confirma√ß√£o
   - Se OK ‚Üí Redirecionar para link_pagamento
```

### P√°gina de Pagamento (`/publico/pagar/[cobranca_id]`)

```
1. Extrair cobranca_id da URL
2. Chamar consultar_cobranca_sem_auth
   - Se erro ‚Üí Exibir mensagem apropriada
   - Se OK ‚Üí Exibir dados da cobran√ßa

3. Exibir:
   - Nome do cliente
   - Valor
   - Vencimento (com destaque se vencida)
   - Nome do assinante/empresa
   - Contato do assinante

4. Bot√£o "Pagar" ‚Üí (Edge Function de pagamento - Fase 5)
```

---

## üîí Considera√ß√µes de Seguran√ßa

1. **UUIDs Imprevis√≠veis:** Os IDs usam UUID v7, imposs√≠veis de adivinhar
2. **Valida√ß√µes Rigorosas:** Toda requisi√ß√£o valida plano/cobran√ßa/assinante ativos
3. **Dados Limitados:** APIs p√∫blicas n√£o exp√µem dados sens√≠veis (observa√ß√µes, IDs internos)
4. **Rate Limiting:** TODO - Implementar se necess√°rio para prevenir abuso

---

## üì± Exemplo Next.js/React

```typescript
// pages/publico/assinar/[plano_id].tsx
import { useRouter } from 'next/router'
import { useEffect, useState } from 'react'
import { supabase } from '@/lib/supabase'

export default function AssinarPage() {
  const router = useRouter()
  const { plano_id } = router.query
  
  const [plano, setPlano] = useState(null)
  const [assinante, setAssinante] = useState(null)
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState(null)
  
  useEffect(() => {
    if (!plano_id) return
    
    async function carregarPlano() {
      const { data } = await supabase.rpc('obter_plano_para_assinatura_sem_auth', {
        p_cliente_plano_id: plano_id
      })
      
      if (data?.status === 'OK') {
        setPlano(data.data.plano)
        setAssinante(data.data.assinante)
      } else {
        setError(data?.message || 'Link inv√°lido')
      }
      setLoading(false)
    }
    
    carregarPlano()
  }, [plano_id])
  
  if (loading) return <Loading />
  if (error) return <ErrorPage message={error} />
  
  return (
    <FormularioAssinatura 
      plano={plano}
      assinante={assinante}
      onSubmit={handleSubmit}
    />
  )
}
```

---

**√öltima Atualiza√ß√£o:** Dezembro 2025  
**Fase:** 4 - APIs P√∫blicas SEM AUTH

