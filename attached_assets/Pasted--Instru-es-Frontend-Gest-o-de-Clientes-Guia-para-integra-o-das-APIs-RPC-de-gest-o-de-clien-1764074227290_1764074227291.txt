# Instru√ß√µes Frontend - Gest√£o de Clientes

> Guia para integra√ß√£o das APIs RPC de gest√£o de clientes finais no frontend

---

## üìã Vis√£o Geral

O m√≥dulo de clientes permite que o assinante cadastre e gerencie seus clientes finais (alunos, pacientes, etc.) para posterior cria√ß√£o de assinaturas e cobran√ßas.

**Importante:** 
- **TODAS as APIs exigem usu√°rio autenticado** üîê
- O Supabase client passa automaticamente o token quando h√° sess√£o ativa
- Isolamento multi-tenant: Cada assinante s√≥ v√™ seus pr√≥prios clientes

---

## üóÇÔ∏è Resumo dos Endpoints

| Fun√ß√£o | M√©todo | Uso | Autentica√ß√£o |
|--------|--------|-----|--------------|
| `criar_cliente(...)` | RPC | Criar novo cliente | üîê Obrigat√≥ria |
| `atualizar_cliente(...)` | RPC | Atualizar dados do cliente | üîê Obrigat√≥ria |
| `obter_cliente(cliente_id)` | RPC | Buscar cliente por ID | üîê Obrigat√≥ria |
| `buscar_cliente_por_cpf_cnpj(cpf_cnpj)` | RPC | Buscar por CPF/CNPJ | üîê Obrigat√≥ria |
| `listar_clientes(filtros?)` | RPC | Listar com pagina√ß√£o | üîê Obrigat√≥ria |
| `ativar_cliente(cliente_id)` | RPC | Ativar cliente | üîê Obrigat√≥ria |
| `desativar_cliente(cliente_id)` | RPC | Desativar cliente | üîê Obrigat√≥ria |
| `excluir_cliente(cliente_id)` | RPC | Excluir permanentemente | üîê Obrigat√≥ria |

**Fluxo t√≠pico:**
1. Listar clientes com filtros/pagina√ß√£o
2. Criar novo cliente com dados obrigat√≥rios
3. Atualizar dados quando necess√°rio
4. Desativar (soft delete) em vez de excluir

---

## üîê Pr√©-requisito: Autentica√ß√£o

**TODAS as APIs exigem usu√°rio autenticado.** O Supabase client passa automaticamente o token quando h√° sess√£o ativa.

### Verificar Autentica√ß√£o

```typescript
import { supabase } from '@/lib/supabase'

// Verificar se usu√°rio est√° autenticado
const { data: { user } } = await supabase.auth.getUser()

if (!user) {
  router.push('/login')
  return
}
```

---

## üì¶ APIs Dispon√≠veis

### 1. Criar Cliente

**Fun√ß√£o:** `criar_cliente(...)`  
**Uso:** Cadastrar novo cliente final  
**Requer:** üîê Usu√°rio autenticado

#### Par√¢metros

| Campo | Tipo | Obrigat√≥rio | Descri√ß√£o |
|-------|------|-------------|-----------|
| `p_nome` | `TEXT` | ‚úÖ Sim | Nome completo do cliente |
| `p_nome_visualizacao` | `TEXT` | ‚ùå N√£o | Nome para exibi√ß√£o (apelido) |
| `p_whatsapp` | `TEXT` | ‚ùå N√£o | WhatsApp (apenas n√∫meros) |
| `p_cpf_cnpj` | `VARCHAR(14)` | ‚ùå N√£o | CPF (11 d√≠gitos) ou CNPJ (14 d√≠gitos) |
| `p_tipo_pessoa` | `enum_tipo_pessoa` | ‚ùå N√£o* | `FISICA` ou `JURIDICA` |
| `p_email` | `TEXT` | ‚ùå N√£o | Email v√°lido |
| `p_rua` | `TEXT` | ‚ùå N√£o | Endere√ßo - Rua |
| `p_numero` | `TEXT` | ‚ùå N√£o | Endere√ßo - N√∫mero |
| `p_complemento` | `TEXT` | ‚ùå N√£o | Endere√ßo - Complemento |
| `p_bairro` | `TEXT` | ‚ùå N√£o | Endere√ßo - Bairro |
| `p_cidade` | `TEXT` | ‚ùå N√£o | Endere√ßo - Cidade |
| `p_uf` | `CHAR(2)` | ‚ùå N√£o | Estado (sigla, ex: SP) |
| `p_cep` | `VARCHAR(8)` | ‚ùå N√£o | CEP (apenas n√∫meros) |
| `p_observacao` | `TEXT` | ‚ùå N√£o | Observa√ß√µes gerais |

**\*Nota:** `p_tipo_pessoa` √© **obrigat√≥rio** se `p_cpf_cnpj` for informado.

#### Valida√ß√µes

- ‚úÖ Nome √© obrigat√≥rio e n√£o pode ser vazio
- ‚úÖ CPF/CNPJ deve ser √∫nico por assinante
- ‚úÖ WhatsApp √© normalizado (remove formata√ß√£o)
- ‚úÖ Email deve ter formato v√°lido
- ‚úÖ CEP deve ter 8 d√≠gitos
- ‚úÖ UF deve ter 2 caracteres

#### Response - Sucesso

```typescript
{
  status: "OK",
  message: "Cliente criado com sucesso.",
  data: {
    cliente_id: "uuid-do-cliente"
  }
}
```

#### Response - Erro (CPF/CNPJ Duplicado)

```typescript
{
  status: "ERROR",
  code: "CPF_CNPJ_JA_CADASTRADO",
  message: "J√° existe um cliente cadastrado com este CPF/CNPJ.",
  data: {
    cliente_existente_id: "uuid-cliente-existente"
  }
}
```

#### Exemplo TypeScript

```typescript
import { supabase } from '@/lib/supabase'

interface CriarClienteInput {
  nome: string
  nome_visualizacao?: string
  whatsapp?: string
  cpf_cnpj?: string
  tipo_pessoa?: 'FISICA' | 'JURIDICA'
  email?: string
  endereco?: {
    rua?: string
    numero?: string
    complemento?: string
    bairro?: string
    cidade?: string
    uf?: string
    cep?: string
  }
  observacao?: string
}

async function criarCliente(input: CriarClienteInput) {
  const { data, error } = await supabase.rpc('criar_cliente', {
    p_nome: input.nome,
    p_nome_visualizacao: input.nome_visualizacao,
    p_whatsapp: input.whatsapp,
    p_cpf_cnpj: input.cpf_cnpj,
    p_tipo_pessoa: input.tipo_pessoa,
    p_email: input.email,
    p_rua: input.endereco?.rua,
    p_numero: input.endereco?.numero,
    p_complemento: input.endereco?.complemento,
    p_bairro: input.endereco?.bairro,
    p_cidade: input.endereco?.cidade,
    p_uf: input.endereco?.uf,
    p_cep: input.endereco?.cep,
    p_observacao: input.observacao
  })

  if (error) {
    console.error('Erro ao criar cliente:', error)
    return { sucesso: false, erro: error.message }
  }

  if (data.status === 'ERROR') {
    return {
      sucesso: false,
      erro: data.message,
      codigo: data.code,
      clienteExistenteId: data.data?.cliente_existente_id
    }
  }

  return {
    sucesso: true,
    clienteId: data.data.cliente_id
  }
}
```

#### Exemplo React Component

```tsx
'use client'

import { useState } from 'react'
import { supabase } from '@/lib/supabase'

interface FormData {
  nome: string
  whatsapp: string
  email: string
  cpf_cnpj: string
}

export function FormularioCadastroCliente({ onSucesso }: { onSucesso: () => void }) {
  const [loading, setLoading] = useState(false)
  const [erro, setErro] = useState('')

  const handleSubmit = async (e: React.FormEvent<HTMLFormElement>) => {
    e.preventDefault()
    setLoading(true)
    setErro('')

    const formData = new FormData(e.currentTarget)

    const { data, error } = await supabase.rpc('criar_cliente', {
      p_nome: formData.get('nome'),
      p_whatsapp: formData.get('whatsapp'),
      p_email: formData.get('email'),
      p_cpf_cnpj: formData.get('cpf_cnpj'),
      p_tipo_pessoa: 'FISICA'
    })

    setLoading(false)

    if (error || data?.status === 'ERROR') {
      setErro(data?.message || error.message)
      return
    }

    onSucesso()
  }

  return (
    <form onSubmit={handleSubmit} className="space-y-4">
      <div>
        <label>Nome Completo *</label>
        <input 
          type="text" 
          name="nome" 
          required 
          className="w-full border rounded px-3 py-2"
        />
      </div>

      <div>
        <label>WhatsApp</label>
        <input 
          type="tel" 
          name="whatsapp" 
          placeholder="(11) 99999-9999"
          className="w-full border rounded px-3 py-2"
        />
      </div>

      <div>
        <label>Email</label>
        <input 
          type="email" 
          name="email" 
          className="w-full border rounded px-3 py-2"
        />
      </div>

      <div>
        <label>CPF</label>
        <input 
          type="text" 
          name="cpf_cnpj" 
          placeholder="000.000.000-00"
          className="w-full border rounded px-3 py-2"
        />
      </div>

      {erro && (
        <div className="alert alert-error">
          {erro}
        </div>
      )}

      <button 
        type="submit" 
        disabled={loading}
        className="btn btn-primary w-full"
      >
        {loading ? 'Cadastrando...' : 'Cadastrar Cliente'}
      </button>
    </form>
  )
}
```

---

### 2. Atualizar Cliente

**Fun√ß√£o:** `atualizar_cliente(...)`  
**Uso:** Atualizar dados de um cliente existente  
**Requer:** üîê Usu√°rio autenticado

#### Par√¢metros

| Campo | Tipo | Obrigat√≥rio | Descri√ß√£o |
|-------|------|-------------|-----------|
| `p_cliente_id` | `UUID` | ‚úÖ Sim | ID do cliente a ser atualizado |
| Demais campos | ... | ‚ùå N√£o | Mesmos da cria√ß√£o |

**Importante:** 
- **`NULL`**: Mant√©m o valor atual
- **String vazia `''`**: Limpa o campo (define como NULL)
- **Valor**: Atualiza o campo

#### Exemplo TypeScript

```typescript
async function atualizarCliente(clienteId: string, dados: Partial<CriarClienteInput>) {
  const { data, error } = await supabase.rpc('atualizar_cliente', {
    p_cliente_id: clienteId,
    p_nome: dados.nome ?? null,
    p_whatsapp: dados.whatsapp ?? null,
    p_email: dados.email ?? null,
    // ... outros campos
  })

  if (error || data?.status === 'ERROR') {
    return { sucesso: false, erro: data?.message || error.message }
  }

  return { sucesso: true }
}
```

---

### 3. Obter Cliente por ID

**Fun√ß√£o:** `obter_cliente(cliente_id)`  
**Uso:** Buscar dados completos de um cliente  
**Requer:** üîê Usu√°rio autenticado

#### Par√¢metros

| Campo | Tipo | Obrigat√≥rio | Descri√ß√£o |
|-------|------|-------------|-----------|
| `p_cliente_id` | `UUID` | ‚úÖ Sim | ID do cliente |

#### Response

```typescript
{
  status: "OK",
  message: "Cliente obtido com sucesso.",
  data: {
    cliente_id: "uuid",
    data: {
      id: "uuid",
      nome: "Jo√£o Silva",
      nome_visualizacao: "Jo√£o",
      whatsapp: "5511999999999",
      cpf_cnpj: "12345678900",
      tipo_pessoa: "FISICA",
      email: "joao@email.com",
      rua: "Rua A",
      numero: "123",
      complemento: "Apto 45",
      bairro: "Centro",
      cidade: "S√£o Paulo",
      uf: "SP",
      cep: "01234567",
      observacao: "Cliente VIP",
      ind_ativo: true,
      criado_em: "2024-01-01T00:00:00Z",
      modificado_em: "2024-01-01T00:00:00Z"
    }
  }
}
```

#### Exemplo TypeScript

```typescript
async function obterCliente(clienteId: string) {
  const { data, error } = await supabase.rpc('obter_cliente', {
    p_cliente_id: clienteId
  })

  if (error || data?.status === 'ERROR') {
    return { sucesso: false, erro: data?.message || error.message }
  }

  return {
    sucesso: true,
    cliente: data.data.data
  }
}
```

---

### 4. Buscar Cliente por CPF/CNPJ

**Fun√ß√£o:** `buscar_cliente_por_cpf_cnpj(cpf_cnpj)`  
**Uso:** Verificar se cliente j√° existe antes de cadastrar  
**Requer:** üîê Usu√°rio autenticado

#### Exemplo TypeScript

```typescript
async function buscarClientePorCPF(cpfCnpj: string) {
  const { data, error } = await supabase.rpc('buscar_cliente_por_cpf_cnpj', {
    p_cpf_cnpj: cpfCnpj.replace(/\D/g, '') // Remove formata√ß√£o
  })

  if (error) {
    return { encontrado: false }
  }

  if (data?.status === 'ERROR') {
    return { encontrado: false }
  }

  return {
    encontrado: true,
    cliente: data.data.data
  }
}
```

---

### 5. Listar Clientes (com Pagina√ß√£o)

**Fun√ß√£o:** `listar_clientes(filtros?)`  
**Uso:** Listar clientes com filtros e pagina√ß√£o  
**Requer:** üîê Usu√°rio autenticado

#### Par√¢metros (Todos opcionais)

| Campo | Tipo | Default | Descri√ß√£o |
|-------|------|---------|-----------|
| `p_nome` | `TEXT` | `null` | Filtrar por nome (busca parcial) |
| `p_cpf_cnpj` | `VARCHAR(14)` | `null` | Filtrar por CPF/CNPJ |
| `p_email` | `TEXT` | `null` | Filtrar por email |
| `p_whatsapp` | `TEXT` | `null` | Filtrar por WhatsApp |
| `p_ind_ativo` | `BOOLEAN` | `null` | Filtrar por status (true/false/null=todos) |
| `p_limit` | `INTEGER` | `100` | M√°ximo de registros (m√°x: 1000) |
| `p_offset` | `INTEGER` | `0` | Pagina√ß√£o - in√≠cio |

#### Response

Retorna **array de clientes** diretamente (n√£o √© JSONB):

```typescript
[
  {
    id: "uuid",
    nome: "Jo√£o Silva",
    nome_visualizacao: "Jo√£o",
    whatsapp: "5511999999999",
    cpf_cnpj: "12345678900",
    tipo_pessoa: "FISICA",
    email: "joao@email.com",
    // ... todos os campos
    ind_ativo: true,
    criado_em: "2024-01-01T00:00:00Z",
    modificado_em: "2024-01-01T00:00:00Z"
  },
  // ... mais clientes
]
```

#### Exemplo TypeScript

```typescript
interface ListarClientesInput {
  nome?: string
  cpf_cnpj?: string
  email?: string
  whatsapp?: string
  ind_ativo?: boolean
  limit?: number
  offset?: number
}

async function listarClientes(filtros?: ListarClientesInput) {
  const { data, error } = await supabase.rpc('listar_clientes', {
    p_nome: filtros?.nome,
    p_cpf_cnpj: filtros?.cpf_cnpj,
    p_email: filtros?.email,
    p_whatsapp: filtros?.whatsapp,
    p_ind_ativo: filtros?.ind_ativo,
    p_limit: filtros?.limit ?? 100,
    p_offset: filtros?.offset ?? 0
  })

  if (error) {
    console.error('Erro ao listar clientes:', error)
    return { sucesso: false, erro: error.message, clientes: [] }
  }

  return {
    sucesso: true,
    clientes: data || []
  }
}
```

#### Exemplo React Component com Pagina√ß√£o

```tsx
'use client'

import { useEffect, useState } from 'react'
import { supabase } from '@/lib/supabase'

interface Cliente {
  id: string
  nome: string
  whatsapp: string
  email: string
  ind_ativo: boolean
}

export function ListaClientes() {
  const [clientes, setClientes] = useState<Cliente[]>([])
  const [loading, setLoading] = useState(true)
  const [filtros, setFiltros] = useState({
    nome: '',
    ind_ativo: undefined as boolean | undefined,
    limit: 50,
    offset: 0
  })

  useEffect(() => {
    carregarClientes()
  }, [filtros])

  async function carregarClientes() {
    setLoading(true)

    const { data, error } = await supabase.rpc('listar_clientes', {
      p_nome: filtros.nome || null,
      p_ind_ativo: filtros.ind_ativo ?? null,
      p_limit: filtros.limit,
      p_offset: filtros.offset
    })

    setLoading(false)

    if (!error) {
      setClientes(data || [])
    }
  }

  function proximaPagina() {
    setFiltros(prev => ({ ...prev, offset: prev.offset + prev.limit }))
  }

  function paginaAnterior() {
    setFiltros(prev => ({ ...prev, offset: Math.max(0, prev.offset - prev.limit) }))
  }

  if (loading) return <p>Carregando...</p>

  return (
    <div>
      {/* Filtros */}
      <div className="mb-4 flex gap-4">
        <input
          type="text"
          placeholder="Buscar por nome..."
          value={filtros.nome}
          onChange={(e) => setFiltros(prev => ({ ...prev, nome: e.target.value, offset: 0 }))}
          className="border rounded px-3 py-2"
        />

        <select
          value={filtros.ind_ativo === undefined ? '' : filtros.ind_ativo.toString()}
          onChange={(e) => setFiltros(prev => ({
            ...prev,
            ind_ativo: e.target.value === '' ? undefined : e.target.value === 'true',
            offset: 0
          }))}
          className="border rounded px-3 py-2"
        >
          <option value="">Todos</option>
          <option value="true">Ativos</option>
          <option value="false">Inativos</option>
        </select>
      </div>

      {/* Lista */}
      <div className="space-y-2">
        {clientes.map(cliente => (
          <div key={cliente.id} className="card border rounded p-4">
            <div className="flex justify-between items-center">
              <div>
                <h3 className="font-semibold">{cliente.nome}</h3>
                <p className="text-sm text-gray-600">
                  {cliente.whatsapp && `üì± ${cliente.whatsapp}`}
                  {cliente.email && ` | üìß ${cliente.email}`}
                </p>
              </div>
              <div>
                {cliente.ind_ativo ? (
                  <span className="badge badge-success">Ativo</span>
                ) : (
                  <span className="badge badge-secondary">Inativo</span>
                )}
              </div>
            </div>
          </div>
        ))}
      </div>

      {/* Pagina√ß√£o */}
      <div className="mt-4 flex justify-between items-center">
        <button
          onClick={paginaAnterior}
          disabled={filtros.offset === 0}
          className="btn btn-outline"
        >
          Anterior
        </button>

        <span className="text-sm text-gray-600">
          Exibindo {filtros.offset + 1} - {filtros.offset + clientes.length}
        </span>

        <button
          onClick={proximaPagina}
          disabled={clientes.length < filtros.limit}
          className="btn btn-outline"
        >
          Pr√≥xima
        </button>
      </div>
    </div>
  )
}
```

---

### 6. Ativar Cliente

**Fun√ß√£o:** `ativar_cliente(cliente_id)`  
**Uso:** Ativar cliente previamente desativado  
**Requer:** üîê Usu√°rio autenticado

```typescript
async function ativarCliente(clienteId: string) {
  const { data, error } = await supabase.rpc('ativar_cliente', {
    p_cliente_id: clienteId
  })

  if (error || data?.status === 'ERROR') {
    return { sucesso: false, erro: data?.message || error.message }
  }

  return { sucesso: true }
}
```

---

### 7. Desativar Cliente

**Fun√ß√£o:** `desativar_cliente(cliente_id)`  
**Uso:** Desativar cliente (soft delete - preserva dados)  
**Requer:** üîê Usu√°rio autenticado

```typescript
async function desativarCliente(clienteId: string) {
  const { data, error } = await supabase.rpc('desativar_cliente', {
    p_cliente_id: clienteId
  })

  if (error || data?.status === 'ERROR') {
    return { sucesso: false, erro: data?.message || error.message }
  }

  return { sucesso: true }
}
```

---

### 8. Excluir Cliente

**Fun√ß√£o:** `excluir_cliente(cliente_id)`  
**Uso:** Excluir cliente permanentemente (hard delete)  
**Requer:** üîê Usu√°rio autenticado

**‚ö†Ô∏è ATEN√á√ÉO:** Esta a√ß√£o √© **irrevers√≠vel**! Prefira usar `desativar_cliente`.

```typescript
async function excluirCliente(clienteId: string) {
  // Confirma√ß√£o recomendada
  if (!confirm('Tem certeza? Esta a√ß√£o n√£o pode ser desfeita!')) {
    return { sucesso: false, erro: 'A√ß√£o cancelada' }
  }

  const { data, error } = await supabase.rpc('excluir_cliente', {
    p_cliente_id: clienteId
  })

  if (error || data?.status === 'ERROR') {
    return { sucesso: false, erro: data?.message || error.message }
  }

  return { sucesso: true }
}
```

---

## üîê Tratamento de Erros

Todas as APIs seguem o padr√£o de resposta unificado:

```typescript
// Resposta de SUCESSO
{
  status: "OK",
  message: "Mensagem descritiva",
  data: { /* dados espec√≠ficos */ }
}

// Resposta de ERRO
{
  status: "ERROR",
  message: "Mensagem descritiva do erro",
  code: "CODIGO_ERRO",
  data: { /* dados adicionais se houver */ }
}
```

### C√≥digos de Erro Comuns

| C√≥digo | Descri√ß√£o | Solu√ß√£o |
|--------|-----------|---------|
| `NOME_OBRIGATORIO` | Nome n√£o fornecido | Validar campo obrigat√≥rio |
| `CPF_CNPJ_JA_CADASTRADO` | CPF/CNPJ duplicado | Usar cliente existente ou atualizar |
| `EMAIL_INVALIDO` | Formato de email inv√°lido | Validar formato no frontend |
| `WHATSAPP_INVALIDO` | WhatsApp com formato inv√°lido | Validar apenas n√∫meros |
| `CEP_INVALIDO` | CEP deve ter 8 d√≠gitos | Validar tamanho |
| `CLIENTE_NAO_ENCONTRADO` | Cliente n√£o existe | Verificar ID |
| `CLIENTE_NAO_PERTENCE_ASSINANTE` | Cliente de outro assinante | Validar permiss√µes |
| `CLIENTE_JA_ATIVO` | Cliente j√° est√° ativo | Verificar status antes |
| `CLIENTE_JA_INATIVO` | Cliente j√° est√° inativo | Verificar status antes |

---

## üìù Notas Importantes

1. **Autentica√ß√£o Obrigat√≥ria** üîê
   - Todas as APIs exigem usu√°rio autenticado
   - Token √© passado automaticamente pelo Supabase client
   - Sem autentica√ß√£o = erro 401

2. **Isolamento Multi-tenant**
   - Cada assinante s√≥ v√™ seus pr√≥prios clientes
   - N√£o √© necess√°rio passar `assinante_id` como par√¢metro
   - Sistema valida automaticamente via `auth.uid()`

3. **Normaliza√ß√£o Autom√°tica**
   - **WhatsApp**: Remove formata√ß√£o, mant√©m apenas n√∫meros
   - **CPF/CNPJ**: Remove formata√ß√£o, mant√©m apenas n√∫meros
   - **CEP**: Remove formata√ß√£o, mant√©m apenas n√∫meros

4. **Soft Delete vs Hard Delete**
   - **`desativar_cliente`**: Recomendado (mant√©m dados, pode reativar)
   - **`excluir_cliente`**: Irrevers√≠vel (apaga permanentemente)

5. **Atualiza√ß√£o Parcial**
   - Use `null` para manter valor atual
   - Use `''` (string vazia) para limpar campo opcional

6. **Valida√ß√£o de Duplicidade**
   - CPF/CNPJ √© √∫nico por assinante
   - Backend retorna `cliente_existente_id` em caso de duplicidade
   - Frontend pode oferecer op√ß√£o de usar cliente existente

7. **Pagina√ß√£o**
   - Limite padr√£o: 100 registros
   - Limite m√°ximo: 1000 registros
   - Use `offset` para navegar p√°ginas

8. **Ordena√ß√£o**
   - Clientes ativos aparecem primeiro
   - Depois ordenados por nome (A-Z)

---

## üéØ Fluxos de UI Comuns

### Fluxo 1: Cadastro de Cliente

```tsx
'use client'

import { useState } from 'react'
import { supabase } from '@/lib/supabase'

export function CadastroCliente() {
  const [loading, setLoading] = useState(false)
  const [erro, setErro] = useState('')
  const [sucesso, setSucesso] = useState(false)

  const handleSubmit = async (e: React.FormEvent<HTMLFormElement>) => {
    e.preventDefault()
    setLoading(true)
    setErro('')
    setSucesso(false)

    const formData = new FormData(e.currentTarget)

    // 1. Verificar se CPF j√° existe (opcional)
    const cpfCnpj = formData.get('cpf_cnpj') as string
    if (cpfCnpj) {
      const { data: buscaData } = await supabase.rpc('buscar_cliente_por_cpf_cnpj', {
        p_cpf_cnpj: cpfCnpj.replace(/\D/g, '')
      })

      if (buscaData?.status === 'OK') {
        setErro('J√° existe um cliente com este CPF. Deseja editar o cadastro existente?')
        setLoading(false)
        return
      }
    }

    // 2. Criar cliente
    const { data, error } = await supabase.rpc('criar_cliente', {
      p_nome: formData.get('nome'),
      p_whatsapp: formData.get('whatsapp'),
      p_email: formData.get('email'),
      p_cpf_cnpj: cpfCnpj.replace(/\D/g, '') || null,
      p_tipo_pessoa: 'FISICA'
    })

    setLoading(false)

    if (error || data?.status === 'ERROR') {
      setErro(data?.message || error.message)
      return
    }

    setSucesso(true)
    // Redirecionar ou limpar formul√°rio
  }

  if (sucesso) {
    return (
      <div className="alert alert-success">
        Cliente cadastrado com sucesso!
      </div>
    )
  }

  return (
    <form onSubmit={handleSubmit} className="space-y-4">
      {/* Campos do formul√°rio */}
      {erro && <div className="alert alert-error">{erro}</div>}
      <button type="submit" disabled={loading}>
        {loading ? 'Cadastrando...' : 'Cadastrar'}
      </button>
    </form>
  )
}
```

---

### Fluxo 2: Busca e Edi√ß√£o

```tsx
async function buscarEEditar(cpfCnpj: string) {
  // 1. Buscar cliente
  const { data: buscaData } = await supabase.rpc('buscar_cliente_por_cpf_cnpj', {
    p_cpf_cnpj: cpfCnpj
  })

  if (buscaData?.status === 'OK') {
    const cliente = buscaData.data.data

    // 2. Exibir modal de edi√ß√£o com dados preenchidos
    // ...

    // 3. Atualizar quando usu√°rio submeter
    const { data: updateData } = await supabase.rpc('atualizar_cliente', {
      p_cliente_id: cliente.id,
      p_nome: novoNome,
      // ... outros campos
    })
  }
}
```

---

### Fluxo 3: Lista com A√ß√µes

```tsx
export function TabelaClientes() {
  const [clientes, setClientes] = useState([])

  async function handleDesativar(clienteId: string) {
    const { data } = await supabase.rpc('desativar_cliente', {
      p_cliente_id: clienteId
    })

    if (data?.status === 'OK') {
      // Recarregar lista
      carregarClientes()
    }
  }

  return (
    <table>
      {clientes.map(cliente => (
        <tr key={cliente.id}>
          <td>{cliente.nome}</td>
          <td>
            {cliente.ind_ativo ? (
              <button onClick={() => handleDesativar(cliente.id)}>
                Desativar
              </button>
            ) : (
              <button onClick={() => handleAtivar(cliente.id)}>
                Ativar
              </button>
            )}
          </td>
        </tr>
      ))}
    </table>
  )
}
```

---

## üöÄ Checklist de Implementa√ß√£o

### Backend (‚úÖ Completo)
- ‚úÖ Tabela `cliente` criada com todos os campos
- ‚úÖ Fun√ß√µes `app_internal` implementadas
- ‚úÖ APIs RPC p√∫blicas criadas
- ‚úÖ RLS configurado

### Frontend (‚è≥ A fazer)
- [ ] P√°gina de listagem de clientes
- [ ] Formul√°rio de cadastro
- [ ] Formul√°rio de edi√ß√£o
- [ ] Busca por CPF/CNPJ
- [ ] Filtros e pagina√ß√£o
- [ ] A√ß√µes de ativar/desativar
- [ ] Valida√ß√£o de campos no frontend

---

## üìö Recursos Adicionais

- [Planejamento Fase 2](../../../../docs/backend/Fase%202/PLANO_FASE2_GESTAO_CLIENTES.md)
- [Fun√ß√µes Internas app_internal](../../app_internal/cliente_final/cliente.sql)

---

**√öltima Atualiza√ß√£o**: Novembro 2025  
**Status**: Documenta√ß√£o completa - Pronto para implementa√ß√£o frontend

