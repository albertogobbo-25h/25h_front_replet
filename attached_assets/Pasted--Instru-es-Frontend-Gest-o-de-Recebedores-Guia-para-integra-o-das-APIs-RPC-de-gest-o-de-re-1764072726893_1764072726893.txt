# Instru√ß√µes Frontend - Gest√£o de Recebedores

> Guia para integra√ß√£o das APIs RPC de gest√£o de recebedores no frontend

---

## üìã Vis√£o Geral

O m√≥dulo de recebedores permite que o assinante configure a conta banc√°ria onde receber√° os pagamentos dos clientes via Pluggy.

**Importante:** 
- **Consultas** s√£o feitas via **RPC** (simples, r√°pidas, s√≠ncronas)
- **Cria√ß√£o/ativa√ß√£o** √© feita via **Edge Function** (integra com Pluggy via N8N)

---

## üóÇÔ∏è Resumo dos Endpoints

| Tipo | Nome | M√©todo | Uso | Integra Pluggy? |
|------|------|--------|-----|-----------------|
| RPC | `obter_recebedor_ativo()` | - | Consultar conta ativa | ‚ùå |
| RPC | `listar_recebedores(somente_ativos?)` | - | Listar hist√≥rico | ‚ùå |
| Edge Function | `cadastrar_recebedor` | POST | Criar nova conta | ‚úÖ Via N8N |
| Edge Function | `ativar_recebedor` | POST | Ativar/reativar conta | ‚úÖ Se necess√°rio |

**Fluxo t√≠pico:**
1. Frontend lista recebedores com `listar_recebedores()` (valida√ß√£o local)
2. Frontend chama `cadastrar_recebedor` (Edge Function ‚Üí N8N ‚Üí Pluggy)
3. Se falhar, frontend chama `ativar_recebedor` com `recebedor_id` retornado
4. Frontend atualiza UI chamando `obter_recebedor_ativo()`

---

## üì¶ Recursos Dispon√≠veis

### APIs RPC (Consulta)
1. `obter_recebedor_ativo()` - Consulta conta ativa
2. `listar_recebedores()` - Lista hist√≥rico (use para valida√ß√£o local tamb√©m)

### Edge Functions (A√ß√µes)
1. `cadastrar_recebedor` - Cria nova conta (banco + Pluggy via N8N)
2. `ativar_recebedor` - Ativa/reativa conta existente

---

## üîê Pr√©-requisito: Autentica√ß√£o

**TODAS as APIs exigem usu√°rio autenticado.** O Supabase client passa automaticamente o token quando h√° sess√£o ativa.

### Verificar Autentica√ß√£o

```typescript
import { supabase } from '@/lib/supabase'

// Verificar se usu√°rio est√° autenticado
const { data: { user } } = await supabase.auth.getUser()

if (!user) {
  // Redirecionar para login
  router.push('/login')
  return
}

// Usu√°rio autenticado, pode usar as APIs
```

### Exemplo de Setup Inicial

```typescript
// Em um componente protegido (ex: /dashboard/recebimento)
useEffect(() => {
  const checkAuth = async () => {
    const { data: { user } } = await supabase.auth.getUser()
    
    if (!user) {
      router.push('/login')
    }
  }
  
  checkAuth()
}, [])
```

---

### 1. Obter Recebedor Ativo

**Fun√ß√£o:** `obter_recebedor_ativo()`  
**Uso:** Exibir conta ativa na p√°gina de configura√ß√µes  
**Requer:** üîê Usu√°rio autenticado

#### Exemplo TypeScript

```typescript
import { supabase } from '@/lib/supabase'

async function obterRecebedorAtivo() {
  const { data, error } = await supabase.rpc('obter_recebedor_ativo')
  
  if (error) {
    console.error('Erro ao obter recebedor:', error)
    return null
  }

  // Estrutura da resposta
  console.log(data)
  // {
  //   status: "OK",
  //   message: "Recebedor ativo obtido com sucesso",
  //   data: {
  //     recebedor: {
  //       id: "uuid",
  //       gateway_id: "uuid",
  //       id_recebedor_gateway: "pluggy-recipient-id",
  //       instituicao_id: "uuid-instituicao",
  //       instituicao_nome: "Banco do Brasil",
  //       agencia: "0001",
  //       conta: "12345",
  //       tipo_conta: "CHECKING_ACCOUNT",
  //       ind_ativo: true,
  //       criado_em: "2024-01-01T00:00:00Z",
  //       modificado_em: "2024-01-01T00:00:00Z"
  //     }
  //   }
  // }

  return data.data.recebedor
}
```

#### Exemplo React Component

```tsx
'use client'

import { useEffect, useState } from 'react'
import { supabase } from '@/lib/supabase'

interface Recebedor {
  id: string
  instituicao_nome: string
  agencia: string
  conta: string
  tipo_conta: 'CHECKING_ACCOUNT' | 'SAVINGS_ACCOUNT'
  ind_ativo: boolean
}

export function RecebedorAtivo() {
  const [recebedor, setRecebedor] = useState<Recebedor | null>(null)
  const [loading, setLoading] = useState(true)

  useEffect(() => {
    async function carregar() {
      const { data, error } = await supabase.rpc('obter_recebedor_ativo')
      
      if (!error && data.status === 'OK') {
        setRecebedor(data.data.recebedor)
      }
      
      setLoading(false)
    }
    
    carregar()
  }, [])

  if (loading) return <p>Carregando...</p>
  
  if (!recebedor) {
    return (
      <div className="alert alert-warning">
        <p>Nenhuma conta configurada.</p>
        <button>Cadastrar Conta</button>
      </div>
    )
  }

  const tipoConta = recebedor.tipo_conta === 'CHECKING_ACCOUNT' 
    ? 'Conta Corrente' 
    : 'Conta Poupan√ßa'

  return (
    <div className="card">
      <h3>Conta Ativa</h3>
      <p><strong>Banco:</strong> {recebedor.instituicao_nome}</p>
      <p><strong>Ag√™ncia:</strong> {recebedor.agencia}</p>
      <p><strong>Conta:</strong> {recebedor.conta}</p>
      <p><strong>Tipo:</strong> {tipoConta}</p>
      <button>Trocar Conta</button>
    </div>
  )
}
```

---

### 2. Listar Recebedores (Hist√≥rico)

**Fun√ß√£o:** `listar_recebedores(p_somente_ativos?)`  
**Uso:** Exibir hist√≥rico de contas (ativas e inativas)  
**Requer:** üîê Usu√°rio autenticado

#### Par√¢metros

| Par√¢metro | Tipo | Obrigat√≥rio | Default | Descri√ß√£o |
|-----------|------|-------------|---------|-----------|
| `p_somente_ativos` | `boolean` | N√£o | `false` | Se `true`, lista apenas recebedores ativos |

#### Exemplo TypeScript

```typescript
async function listarRecebedores(somenteAtivos = false) {
  const { data, error } = await supabase.rpc('listar_recebedores', {
    p_somente_ativos: somenteAtivos
  })
  
  if (error) {
    console.error('Erro ao listar recebedores:', error)
    return []
  }

  // Estrutura da resposta
  console.log(data)
  // {
  //   status: "OK",
  //   message: "Listados 3 recebedor(es)",
  //   data: {
  //     recebedores: [
  //       {
  //         id: "uuid-1",
  //         instituicao_nome: "Banco do Brasil",
  //         agencia: "0001",
  //         conta: "12345",
  //         tipo_conta: "CHECKING_ACCOUNT",
  //         ind_ativo: true,
  //         data_inativacao: null,
  //         criado_em: "2024-01-01T00:00:00Z"
  //       },
  //       {
  //         id: "uuid-2",
  //         instituicao_nome: "Ita√∫",
  //         agencia: "0002",
  //         conta: "67890",
  //         tipo_conta: "SAVINGS_ACCOUNT",
  //         ind_ativo: false,
  //         data_inativacao: "2024-01-15T00:00:00Z",
  //         criado_em: "2023-12-01T00:00:00Z"
  //       }
  //     ],
  //     total: 3
  //   }
  // }

  return data.data.recebedores
}
```

#### Exemplo React Component

```tsx
'use client'

import { useEffect, useState } from 'react'
import { supabase } from '@/lib/supabase'
import { Badge } from '@/components/ui/badge'

interface Recebedor {
  id: string
  instituicao_nome: string
  agencia: string
  conta: string
  tipo_conta: string
  ind_ativo: boolean
  data_inativacao: string | null
  criado_em: string
}

export function HistoricoRecebedores() {
  const [recebedores, setRecebedores] = useState<Recebedor[]>([])
  const [loading, setLoading] = useState(true)

  useEffect(() => {
    async function carregar() {
      const { data, error } = await supabase.rpc('listar_recebedores', {
        p_somente_ativos: false // Listar todos
      })
      
      if (!error && data.status === 'OK') {
        setRecebedores(data.data.recebedores || [])
      }
      
      setLoading(false)
    }
    
    carregar()
  }, [])

  if (loading) return <p>Carregando...</p>
  
  if (recebedores.length === 0) {
    return <p>Nenhuma conta cadastrada.</p>
  }

  return (
    <div className="space-y-4">
      <h3>Hist√≥rico de Contas</h3>
      {recebedores.map((rec) => (
        <div key={rec.id} className="card">
          <div className="flex justify-between items-start">
            <div>
              <p className="font-semibold">{rec.instituicao_nome}</p>
              <p className="text-sm text-gray-600">
                Ag: {rec.agencia} | Conta: {rec.conta}
              </p>
              <p className="text-xs text-gray-500">
                Cadastrado em: {new Date(rec.criado_em).toLocaleDateString()}
              </p>
            </div>
            <div>
              {rec.ind_ativo ? (
                <Badge variant="success">Ativa</Badge>
              ) : (
                <Badge variant="secondary">Inativa</Badge>
              )}
            </div>
          </div>
          {!rec.ind_ativo && (
            <button className="mt-2 text-sm">Reativar Conta</button>
          )}
        </div>
      ))}
    </div>
  )
}
```

---

### 3. Valida√ß√£o de Duplicidade (Frontend Local)

**N√£o h√° API espec√≠fica para isso!** Use `listar_recebedores()` e valide localmente no frontend.

#### Por que valida√ß√£o local?

1. **Backend j√° valida**: A Edge Function de cria√ß√£o valida duplicidade
2. **Menos requisi√ß√µes**: Usa dados j√° carregados
3. **UX melhor**: Feedback instant√¢neo sem esperar API

#### Exemplo React Hook (Valida√ß√£o Local)

```tsx
'use client'

import { useState, useEffect } from 'react'
import { supabase } from '@/lib/supabase'

interface Recebedor {
  id: string
  instituicao_id: string
  agencia: string
  conta: string
  tipo_conta: string
  ind_ativo: boolean
}

export function useValidarContaDuplicada() {
  const [recebedores, setRecebedores] = useState<Recebedor[]>([])
  const [carregando, setCarregando] = useState(true)

  // Carregar recebedores ao montar
  useEffect(() => {
    async function carregar() {
      const { data, error } = await supabase.rpc('listar_recebedores', {
        p_somente_ativos: false // Buscar todos (ativos e inativos)
      })
      
      if (!error && data.status === 'OK') {
        setRecebedores(data.data.recebedores || [])
      }
      
      setCarregando(false)
    }
    
    carregar()
  }, [])

  // Fun√ß√£o de valida√ß√£o local
  const validar = (
    instituicaoId: string,
    agencia: string,
    conta: string,
    tipoConta: 'CHECKING_ACCOUNT' | 'SAVINGS_ACCOUNT'
  ) => {
    // Normalizar ag√™ncia e conta (mesmo que backend faz)
    const agenciaNorm = agencia.replace(/[^0-9]/g, '')
    const contaNorm = conta.replace(/[^0-9]/g, '')

    // Buscar recebedor com mesmos dados
    const recebedorExistente = recebedores.find(
      r => r.instituicao_id === instituicaoId &&
           r.agencia === agenciaNorm &&
           r.conta === contaNorm &&
           r.tipo_conta === tipoConta
    )

    if (!recebedorExistente) {
      return { valido: true }
    }

    if (recebedorExistente.ind_ativo) {
      return {
        valido: false,
        erro: 'Esta conta j√° est√° ativa.',
        recebedorId: recebedorExistente.id
      }
    }

    return {
      valido: false,
      erro: 'Esta conta j√° foi cadastrada. Use "Reativar Conta".',
      recebedorId: recebedorExistente.id,
      podeReativar: true
    }
  }

  return { validar, carregando, recebedores }
}

// Uso no formul√°rio
export function FormularioCadastrarConta() {
  const { validar, carregando } = useValidarContaDuplicada()
  const [erro, setErro] = useState('')

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault()
    
    const formData = new FormData(e.target as HTMLFormElement)
    const instituicaoId = formData.get('instituicao_id') as string
    const agencia = formData.get('agencia') as string
    const conta = formData.get('conta') as string
    const tipoConta = formData.get('tipo_conta') as 'CHECKING_ACCOUNT' | 'SAVINGS_ACCOUNT'

    // Validar duplicidade LOCALMENTE
    const resultado = validar(instituicaoId, agencia, conta, tipoConta)
    
    if (!resultado.valido) {
      setErro(resultado.erro)
      return
    }

    // Se passou na valida√ß√£o, chamar Edge Function para cadastrar
    // ...
  }

  if (carregando) return <p>Carregando...</p>

  return (
    <form onSubmit={handleSubmit}>
      {/* Campos do formul√°rio */}
      {erro && <div className="alert alert-error">{erro}</div>}
      <button type="submit">Cadastrar Conta</button>
    </form>
  )
}
```

**Vantagens da valida√ß√£o local:**
- ‚úÖ Feedback instant√¢neo (sem esperar API)
- ‚úÖ Menos requisi√ß√µes ao backend
- ‚úÖ Funciona offline (com dados em cache)
- ‚úÖ Backend ainda valida (seguran√ßa em camadas)

---

## üöÄ Edge Functions (A√ß√µes)

As Edge Functions s√£o usadas para **criar** e **ativar** recebedores, pois envolvem integra√ß√£o com Pluggy via N8N.

---

### 4. Cadastrar Novo Recebedor

**Fun√ß√£o:** `cadastrar_recebedor`  
**Uso:** Criar nova conta banc√°ria (banco + Pluggy)  
**Requer:** üîê Usu√°rio autenticado

#### Endpoint

```
POST /functions/v1/cadastrar_recebedor
```

#### Request Body

```typescript
{
  instituicao_id: string;  // UUID da institui√ß√£o financeira (Pluggy)
  agencia: string;         // Ex: "0001" ou "0001-9" (ser√° normalizado)
  conta: string;           // Ex: "12345" ou "12345-6" (ser√° normalizado)
  tipo_conta: "CHECKING_ACCOUNT" | "SAVINGS_ACCOUNT";
}
```

#### Response - Sucesso

```typescript
{
  status: "success",
  message: "Recebedor cadastrado e ativado com sucesso",
  data: {
    recebedor_id: string;           // UUID do recebedor criado
    id_recebedor_gateway: string;   // ID retornado pela Pluggy
    ativo: true
  }
}
```

#### Response - Erro (mas recebedor criado)

```typescript
{
  status: "error",
  message: "Falha ao cadastrar recebedor na Pluggy. Tente novamente.",
  code: "N8N_REQUEST_FAILED",
  data: {
    recebedor_id: string;  // üîë Use para tentar novamente!
    pode_retry: true,
    http_status: 500,
    details: "..."
  }
}
```

**Importante:** Mesmo em erro, o `recebedor_id` √© retornado. Use-o para **tentar novamente** com `ativar_recebedor`.

#### Exemplo TypeScript

```typescript
import { supabase } from '@/lib/supabase'

interface CadastrarRecebedorInput {
  instituicao_id: string
  agencia: string
  conta: string
  tipo_conta: 'CHECKING_ACCOUNT' | 'SAVINGS_ACCOUNT'
}

interface CadastrarRecebedorResponse {
  sucesso: boolean
  recebedorId?: string
  idRecebedorGateway?: string
  erro?: string
  podeRetry?: boolean
}

async function cadastrarRecebedor(
  input: CadastrarRecebedorInput
): Promise<CadastrarRecebedorResponse> {
  const { data, error } = await supabase.functions.invoke('cadastrar_recebedor', {
    body: input
  })

  if (error) {
    console.error('Erro ao chamar Edge Function:', error)
    return { sucesso: false, erro: error.message }
  }

  if (data.status === 'error') {
    console.error('Erro retornado pela Edge Function:', data)
    
    // Se tem recebedor_id, pode tentar novamente
    if (data.data?.recebedor_id) {
      return {
        sucesso: false,
        erro: data.message,
        recebedorId: data.data.recebedor_id,
        podeRetry: true
      }
    }
    
    return { sucesso: false, erro: data.message }
  }

  return {
    sucesso: true,
    recebedorId: data.data.recebedor_id,
    idRecebedorGateway: data.data.id_recebedor_gateway
  }
}

// Uso
const resultado = await cadastrarRecebedor({
  instituicao_id: 'uuid-instituicao',
  agencia: '0001',
  conta: '12345',
  tipo_conta: 'CHECKING_ACCOUNT'
})

if (resultado.sucesso) {
  console.log('Recebedor cadastrado:', resultado.recebedorId)
} else if (resultado.podeRetry) {
  console.log('Erro tempor√°rio. Pode tentar novamente.')
  // Mostrar bot√£o "Tentar Novamente" que chama ativar_recebedor
} else {
  console.log('Erro definitivo:', resultado.erro)
}
```

#### Exemplo React Component

```tsx
'use client'

import { useState } from 'react'
import { supabase } from '@/lib/supabase'

interface Props {
  onSucesso: () => void
  onErro: (mensagem: string, recebedorId?: string) => void
}

export function FormularioCadastrarRecebedor({ onSucesso, onErro }: Props) {
  const [loading, setLoading] = useState(false)
  const [erro, setErro] = useState('')

  const handleSubmit = async (e: React.FormEvent<HTMLFormElement>) => {
    e.preventDefault()
    setLoading(true)
    setErro('')

    const formData = new FormData(e.currentTarget)
    
    const { data, error } = await supabase.functions.invoke('cadastrar_recebedor', {
      body: {
        instituicao_id: formData.get('instituicao_id'),
        agencia: formData.get('agencia'),
        conta: formData.get('conta'),
        tipo_conta: formData.get('tipo_conta')
      }
    })

    setLoading(false)

    if (error || data.status === 'error') {
      const mensagem = data?.message || error.message
      setErro(mensagem)
      
      // Se tem recebedor_id, passar para componente pai para mostrar "Retry"
      if (data?.data?.recebedor_id) {
        onErro(mensagem, data.data.recebedor_id)
      } else {
        onErro(mensagem)
      }
      return
    }

    onSucesso()
  }

  return (
    <form onSubmit={handleSubmit} className="space-y-4">
      <div>
        <label>Banco</label>
        <select name="instituicao_id" required>
          {/* Lista de institui√ß√µes */}
        </select>
      </div>

      <div>
        <label>Ag√™ncia</label>
        <input 
          type="text" 
          name="agencia" 
          placeholder="0001"
          required 
        />
      </div>

      <div>
        <label>Conta</label>
        <input 
          type="text" 
          name="conta" 
          placeholder="12345"
          required 
        />
      </div>

      <div>
        <label>Tipo de Conta</label>
        <select name="tipo_conta" required>
          <option value="CHECKING_ACCOUNT">Conta Corrente</option>
          <option value="SAVINGS_ACCOUNT">Conta Poupan√ßa</option>
        </select>
      </div>

      {erro && (
        <div className="alert alert-error">
          {erro}
        </div>
      )}

      <button 
        type="submit" 
        disabled={loading}
        className="btn btn-primary w-full"
      >
        {loading ? 'Cadastrando...' : 'Cadastrar Conta'}
      </button>
    </form>
  )
}
```

---

### 5. Ativar/Reativar Recebedor Existente

**Fun√ß√£o:** `ativar_recebedor`  
**Uso:** Ativar conta existente (retry ap√≥s erro OU reativar conta inativa)  
**Requer:** üîê Usu√°rio autenticado

#### Comportamentos

1. **Retry (n√£o tem `id_recebedor_gateway`)**: Tenta cadastrar na Pluggy novamente
2. **Reativar (j√° tem `id_recebedor_gateway`)**: Apenas ativa no banco (n√£o chama N8N)

#### Endpoint

```
POST /functions/v1/ativar_recebedor
```

#### Request Body

```typescript
{
  recebedor_id: string;  // UUID do recebedor a ser ativado
}
```

#### Response - Sucesso (Reativa√ß√£o)

```typescript
{
  status: "success",
  message: "Recebedor reativado com sucesso",
  data: {
    recebedor_id: string;
    id_recebedor_gateway: string;
    ativo: true,
    chamou_n8n: false  // üîë Indica que N√ÉO chamou Pluggy
  }
}
```

#### Response - Sucesso (Retry)

```typescript
{
  status: "success",
  message: "Recebedor cadastrado na Pluggy e ativado com sucesso",
  data: {
    recebedor_id: string;
    id_recebedor_gateway: string;
    ativo: true,
    chamou_n8n: true  // üîë Indica que chamou Pluggy
  }
}
```

#### Exemplo TypeScript

```typescript
import { supabase } from '@/lib/supabase'

interface AtivarRecebedorResponse {
  sucesso: boolean
  recebedorId?: string
  chamouN8n?: boolean
  erro?: string
}

async function ativarRecebedor(
  recebedorId: string
): Promise<AtivarRecebedorResponse> {
  const { data, error } = await supabase.functions.invoke('ativar_recebedor', {
    body: {
      recebedor_id: recebedorId
    }
  })

  if (error) {
    console.error('Erro ao chamar Edge Function:', error)
    return { sucesso: false, erro: error.message }
  }

  if (data.status === 'error') {
    console.error('Erro retornado pela Edge Function:', data)
    return { sucesso: false, erro: data.message }
  }

  return {
    sucesso: true,
    recebedorId: data.data.recebedor_id,
    chamouN8n: data.data.chamou_n8n
  }
}

// Uso 1: Tentar novamente ap√≥s erro no cadastro
async function tentarNovamente(recebedorId: string) {
  const resultado = await ativarRecebedor(recebedorId)
  
  if (resultado.sucesso) {
    if (resultado.chamouN8n) {
      console.log('Cadastrado na Pluggy com sucesso!')
    } else {
      console.log('Reativado com sucesso (j√° estava na Pluggy)')
    }
  } else {
    console.log('Erro:', resultado.erro)
  }
}

// Uso 2: Reativar conta inativa
async function reativarConta(recebedorId: string) {
  const resultado = await ativarRecebedor(recebedorId)
  
  if (resultado.sucesso) {
    console.log('Conta reativada com sucesso!')
    // Atualizar UI para mostrar como ativa
  }
}
```

#### Exemplo React Component

```tsx
'use client'

import { useState } from 'react'
import { supabase } from '@/lib/supabase'

interface Props {
  recebedorId: string
  temIdGateway: boolean  // Se true, √© reativa√ß√£o. Se false, √© retry
  onSucesso: () => void
}

export function BotaoAtivarRecebedor({ recebedorId, temIdGateway, onSucesso }: Props) {
  const [loading, setLoading] = useState(false)
  const [erro, setErro] = useState('')

  const handleAtivar = async () => {
    setLoading(true)
    setErro('')

    const { data, error } = await supabase.functions.invoke('ativar_recebedor', {
      body: { recebedor_id: recebedorId }
    })

    setLoading(false)

    if (error || data.status === 'error') {
      setErro(data?.message || error.message)
      return
    }

    onSucesso()
  }

  const textoBotao = temIdGateway 
    ? (loading ? 'Reativando...' : 'Reativar Conta')
    : (loading ? 'Tentando novamente...' : 'Tentar Novamente')

  return (
    <div>
      <button 
        onClick={handleAtivar} 
        disabled={loading}
        className="btn btn-primary"
      >
        {textoBotao}
      </button>
      {erro && <p className="text-red-500 text-sm mt-2">{erro}</p>}
    </div>
  )
}
```

---

## üîê Tratamento de Erros

Todas as APIs seguem o padr√£o de resposta unificado:

```typescript
// Resposta de SUCESSO
{
  status: "OK",
  message: "Mensagem descritiva",
  data: { /* dados espec√≠ficos */ }
}

// Resposta de ERRO
{
  status: "ERROR",
  message: "Mensagem descritiva do erro",
  code: "CODIGO_ERRO",
  data: null
}
```

### Exemplo de tratamento gen√©rico

```typescript
async function chamarRPC<T>(
  funcao: string, 
  params?: Record<string, any>
): Promise<{ sucesso: boolean; dados?: T; erro?: string }> {
  try {
    const { data, error } = await supabase.rpc(funcao, params)
    
    if (error) {
      console.error(`Erro na RPC ${funcao}:`, error)
      return { sucesso: false, erro: error.message }
    }

    if (data.status !== 'OK') {
      console.error(`Erro no backend ${funcao}:`, data)
      return { sucesso: false, erro: data.message }
    }

    return { sucesso: true, dados: data.data }
  } catch (err) {
    console.error(`Exce√ß√£o ao chamar ${funcao}:`, err)
    return { sucesso: false, erro: 'Erro inesperado' }
  }
}

// Uso
const { sucesso, dados, erro } = await chamarRPC<{ recebedor: Recebedor }>(
  'obter_recebedor_ativo'
)

if (!sucesso) {
  toast.error(erro)
  return
}

console.log(dados.recebedor)
```

---

## üéØ Fluxos de UI Comuns

### Fluxo 1: P√°gina de Configura√ß√£o de Recebimento

Exibe conta ativa ou formul√°rio de cadastro.

```tsx
'use client'

import { useEffect, useState } from 'react'
import { supabase } from '@/lib/supabase'

interface Recebedor {
  id: string
  instituicao: { nome: string; nome_fantasia: string }
  agencia: string
  conta: string
  tipo_conta: string
}

export function PaginaConfiguracaoRecebimento() {
  const [recebedorAtivo, setRecebedorAtivo] = useState<Recebedor | null>(null)
  const [loading, setLoading] = useState(true)

  useEffect(() => {
    carregarRecebedorAtivo()
  }, [])

  async function carregarRecebedorAtivo() {
    const { data } = await supabase.rpc('obter_recebedor_ativo')
    
    if (data?.status === 'OK' && data.data) {
      setRecebedorAtivo(data.data)
    }
    
    setLoading(false)
  }

  if (loading) return <p>Carregando...</p>

  return (
    <div className="max-w-2xl mx-auto p-6">
      <h1 className="text-2xl font-bold mb-6">Configura√ß√£o de Recebimento</h1>
      
      {recebedorAtivo ? (
        <ContaAtiva 
          recebedor={recebedorAtivo} 
          onTrocar={() => setRecebedorAtivo(null)} 
        />
      ) : (
        <FormularioCadastro 
          onSucesso={carregarRecebedorAtivo} 
        />
      )}
    </div>
  )
}
```

---

### Fluxo 2: Cadastro Completo (com Valida√ß√£o + Retry)

Valida duplicidade localmente e trata erros com op√ß√£o de retry.

```tsx
'use client'

import { useState, useEffect } from 'react'
import { supabase } from '@/lib/supabase'
import { useValidarContaDuplicada } from '@/hooks/useValidarContaDuplicada'

export function FormularioCadastro({ onSucesso }: { onSucesso: () => void }) {
  const { validar, carregando: carregandoValidacao } = useValidarContaDuplicada()
  const [loading, setLoading] = useState(false)
  const [erro, setErro] = useState('')
  const [recebedorErroId, setRecebedorErroId] = useState<string | null>(null)

  const handleSubmit = async (e: React.FormEvent<HTMLFormElement>) => {
    e.preventDefault()
    setErro('')
    setRecebedorErroId(null)
    
    const formData = new FormData(e.currentTarget)
    const instituicaoId = formData.get('instituicao_id') as string
    const agencia = formData.get('agencia') as string
    const conta = formData.get('conta') as string
    const tipoConta = formData.get('tipo_conta') as 'CHECKING_ACCOUNT' | 'SAVINGS_ACCOUNT'

    // 1. Validar duplicidade LOCALMENTE
    const validacao = validar(instituicaoId, agencia, conta, tipoConta)
    
    if (!validacao.valido) {
      setErro(validacao.erro)
      if (validacao.podeReativar) {
        setRecebedorErroId(validacao.recebedorId!)
      }
      return
    }

    // 2. Chamar Edge Function para cadastrar
    setLoading(true)

    const { data, error } = await supabase.functions.invoke('cadastrar_recebedor', {
      body: {
        instituicao_id: instituicaoId,
        agencia,
        conta,
        tipo_conta: tipoConta
      }
    })

    setLoading(false)

    if (error || data.status === 'error') {
      const mensagem = data?.message || error.message
      setErro(mensagem)
      
      // Se falhou mas criou o registro, permitir retry
      if (data?.data?.recebedor_id) {
        setRecebedorErroId(data.data.recebedor_id)
      }
      return
    }

    // Sucesso!
    onSucesso()
  }

  const handleRetry = async () => {
    if (!recebedorErroId) return
    
    setLoading(true)
    setErro('')

    const { data, error } = await supabase.functions.invoke('ativar_recebedor', {
      body: { recebedor_id: recebedorErroId }
    })

    setLoading(false)

    if (error || data.status === 'error') {
      setErro(data?.message || error.message)
      return
    }

    // Sucesso!
    onSucesso()
  }

  if (carregandoValidacao) return <p>Carregando...</p>

  return (
    <div>
      <form onSubmit={handleSubmit} className="space-y-4">
        <div>
          <label>Banco</label>
          <select name="instituicao_id" required>
            {/* Lista de institui√ß√µes */}
          </select>
        </div>

        <div>
          <label>Ag√™ncia</label>
          <input type="text" name="agencia" placeholder="0001" required />
        </div>

        <div>
          <label>Conta</label>
          <input type="text" name="conta" placeholder="12345" required />
        </div>

        <div>
          <label>Tipo de Conta</label>
          <select name="tipo_conta" required>
            <option value="CHECKING_ACCOUNT">Conta Corrente</option>
            <option value="SAVINGS_ACCOUNT">Conta Poupan√ßa</option>
          </select>
        </div>

        {erro && (
          <div className="alert alert-error">
            <p>{erro}</p>
            {recebedorErroId && (
              <button 
                type="button"
                onClick={handleRetry}
                disabled={loading}
                className="btn btn-sm btn-outline mt-2"
              >
                {loading ? 'Tentando...' : 'Tentar Novamente'}
              </button>
            )}
          </div>
        )}

        <button 
          type="submit" 
          disabled={loading}
          className="btn btn-primary w-full"
        >
          {loading ? 'Cadastrando...' : 'Cadastrar Conta'}
        </button>
      </form>
    </div>
  )
}
```

---

### Fluxo 3: Hist√≥rico com Op√ß√£o de Reativar

Lista todas as contas (ativas e inativas) com a√ß√£o de reativar.

```tsx
'use client'

import { useEffect, useState } from 'react'
import { supabase } from '@/lib/supabase'
import { Badge } from '@/components/ui/badge'

interface Recebedor {
  id: string
  instituicao_nome: string
  agencia: string
  conta: string
  tipo_conta: string
  ind_ativo: boolean
  id_recebedor_gateway: string | null
  criado_em: string
  data_inativacao: string | null
}

export function HistoricoRecebedores() {
  const [recebedores, setRecebedores] = useState<Recebedor[]>([])
  const [loading, setLoading] = useState(true)
  const [ativandoId, setAtivandoId] = useState<string | null>(null)

  useEffect(() => {
    carregarHistorico()
  }, [])

  async function carregarHistorico() {
    const { data, error } = await supabase.rpc('listar_recebedores', {
      p_somente_ativos: false
    })
    
    if (!error && data.status === 'OK') {
      setRecebedores(data.data.recebedores || [])
    }
    
    setLoading(false)
  }

  async function reativarConta(recebedorId: string) {
    setAtivandoId(recebedorId)

    const { data, error } = await supabase.functions.invoke('ativar_recebedor', {
      body: { recebedor_id: recebedorId }
    })

    setAtivandoId(null)

    if (error || data.status === 'error') {
      alert(data?.message || error.message)
      return
    }

    // Recarregar lista
    carregarHistorico()
  }

  if (loading) return <p>Carregando...</p>
  
  if (recebedores.length === 0) {
    return <p>Nenhuma conta cadastrada.</p>
  }

  return (
    <div className="space-y-4">
      <h3 className="text-lg font-semibold">Hist√≥rico de Contas</h3>
      {recebedores.map((rec) => {
        const tipoConta = rec.tipo_conta === 'CHECKING_ACCOUNT' 
          ? 'Conta Corrente' 
          : 'Conta Poupan√ßa'

        return (
          <div key={rec.id} className="card border rounded-lg p-4">
            <div className="flex justify-between items-start">
              <div>
                <p className="font-semibold">{rec.instituicao_nome}</p>
                <p className="text-sm text-gray-600">
                  {tipoConta} | Ag: {rec.agencia} | Conta: {rec.conta}
                </p>
                <p className="text-xs text-gray-500">
                  Cadastrado em: {new Date(rec.criado_em).toLocaleDateString()}
                </p>
                {rec.data_inativacao && (
                  <p className="text-xs text-gray-500">
                    Inativado em: {new Date(rec.data_inativacao).toLocaleDateString()}
                  </p>
                )}
              </div>
              <div>
                {rec.ind_ativo ? (
                  <Badge variant="success">Ativa</Badge>
                ) : (
                  <Badge variant="secondary">Inativa</Badge>
                )}
              </div>
            </div>
            
            {!rec.ind_ativo && (
              <button 
                onClick={() => reativarConta(rec.id)}
                disabled={ativandoId === rec.id}
                className="mt-3 btn btn-sm btn-outline"
              >
                {ativandoId === rec.id 
                  ? 'Reativando...' 
                  : rec.id_recebedor_gateway 
                    ? 'Reativar Conta' 
                    : 'Tentar Novamente'
                }
              </button>
            )}
          </div>
        )
      })}
    </div>
  )
}
```

---

### Fluxo 4: Trocar Conta Ativa

Inativa a conta atual e ativa outra (ou cadastra nova).

```tsx
'use client'

import { useState } from 'react'
import { supabase } from '@/lib/supabase'

interface Props {
  recebedorAtualId: string
  onSucesso: () => void
}

export function TrocarConta({ recebedorAtualId, onSucesso }: Props) {
  const [passo, setPasso] = useState<'escolher' | 'cadastrar'>('escolher')

  return (
    <div>
      {passo === 'escolher' ? (
        <div>
          <h3>Deseja reativar uma conta anterior ou cadastrar nova?</h3>
          <div className="flex gap-4 mt-4">
            <button 
              onClick={() => setPasso('cadastrar')}
              className="btn btn-primary"
            >
              Cadastrar Nova Conta
            </button>
            <button 
              onClick={() => {/* Mostrar hist√≥rico */}}
              className="btn btn-outline"
            >
              Reativar Conta Anterior
            </button>
          </div>
        </div>
      ) : (
        <FormularioCadastro onSucesso={onSucesso} />
      )}
    </div>
  )
}
```

---

## üõ°Ô∏è Tratamento de Casos Especiais

### Caso 1: Retry ap√≥s Falha Tempor√°ria

```tsx
'use client'

import { useState } from 'react'
import { supabase } from '@/lib/supabase'

interface Estado {
  tipo: 'inicial' | 'cadastrando' | 'erro_retry' | 'sucesso'
  recebedorId?: string
  mensagemErro?: string
}

export function CadastroComRetry() {
  const [estado, setEstado] = useState<Estado>({ tipo: 'inicial' })

  async function cadastrar(formData: FormData) {
    setEstado({ tipo: 'cadastrando' })

    const { data, error } = await supabase.functions.invoke('cadastrar_recebedor', {
      body: {
        instituicao_id: formData.get('instituicao_id'),
        agencia: formData.get('agencia'),
        conta: formData.get('conta'),
        tipo_conta: formData.get('tipo_conta')
      }
    })

    if (error || data.status === 'error') {
      // Se tem recebedor_id, oferece retry
      if (data?.data?.recebedor_id) {
        setEstado({
          tipo: 'erro_retry',
          recebedorId: data.data.recebedor_id,
          mensagemErro: data.message
        })
      } else {
        setEstado({
          tipo: 'inicial',
          mensagemErro: data?.message || error.message
        })
      }
      return
    }

    setEstado({ tipo: 'sucesso' })
  }

  async function tentarNovamente() {
    if (!estado.recebedorId) return

    setEstado({ tipo: 'cadastrando', recebedorId: estado.recebedorId })

    const { data, error } = await supabase.functions.invoke('ativar_recebedor', {
      body: { recebedor_id: estado.recebedorId }
    })

    if (error || data.status === 'error') {
      setEstado({
        tipo: 'erro_retry',
        recebedorId: estado.recebedorId,
        mensagemErro: data?.message || error.message
      })
      return
    }

    setEstado({ tipo: 'sucesso' })
  }

  if (estado.tipo === 'sucesso') {
    return <div className="alert alert-success">Conta cadastrada com sucesso!</div>
  }

  if (estado.tipo === 'erro_retry') {
    return (
      <div className="alert alert-warning">
        <p>{estado.mensagemErro}</p>
        <button 
          onClick={tentarNovamente}
          className="btn btn-sm btn-primary mt-2"
        >
          Tentar Novamente
        </button>
      </div>
    )
  }

  return (
    <form onSubmit={(e) => { e.preventDefault(); cadastrar(new FormData(e.currentTarget)) }}>
      {/* Campos do formul√°rio */}
      {estado.mensagemErro && (
        <div className="alert alert-error">{estado.mensagemErro}</div>
      )}
      <button 
        type="submit" 
        disabled={estado.tipo === 'cadastrando'}
        className="btn btn-primary"
      >
        {estado.tipo === 'cadastrando' ? 'Cadastrando...' : 'Cadastrar'}
      </button>
    </form>
  )
}
```

---

### Caso 2: Verificar se Assinante tem CPF/CNPJ

```tsx
// Verificar antes de exibir formul√°rio de cadastro

async function verificarPreRequisitos() {
  const { data, error } = await supabase.rpc('obter_dados_assinante')
  
  if (!data?.data?.cpf_cnpj) {
    return {
      podeConfigurar: false,
      mensagem: 'Voc√™ precisa cadastrar CPF/CNPJ antes de configurar recebimento.'
    }
  }

  return { podeConfigurar: true }
}

export function PaginaRecebimento() {
  const [preRequisitos, setPreRequisitos] = useState({ podeConfigurar: false, mensagem: '' })

  useEffect(() => {
    verificarPreRequisitos().then(setPreRequisitos)
  }, [])

  if (!preRequisitos.podeConfigurar) {
    return (
      <div className="alert alert-warning">
        <p>{preRequisitos.mensagem}</p>
        <button onClick={() => router.push('/configuracoes/empresa')}>
          Cadastrar CPF/CNPJ
        </button>
      </div>
    )
  }

  return <FormularioCadastro />
}
```

---

### Caso 3: Carregar Institui√ß√µes Financeiras (Pluggy)

```tsx
'use client'

import { useEffect, useState } from 'react'
import { supabase } from '@/lib/supabase'

interface Instituicao {
  id: string
  nome: string
  nome_fantasia: string
}

export function useInstituicoesFinanceiras() {
  const [instituicoes, setInstituicoes] = useState<Instituicao[]>([])
  const [loading, setLoading] = useState(true)

  useEffect(() => {
    carregarInstituicoes()
  }, [])

  async function carregarInstituicoes() {
    // Supondo que exista uma API RPC para listar institui√ß√µes
    const { data, error } = await supabase.rpc('listar_instituicoes_pluggy')
    
    if (!error && data.status === 'OK') {
      setInstituicoes(data.data.instituicoes)
    }
    
    setLoading(false)
  }

  return { instituicoes, loading }
}

// Uso no formul√°rio
export function SelecionarBanco() {
  const { instituicoes, loading } = useInstituicoesFinanceiras()

  if (loading) return <p>Carregando bancos...</p>

  return (
    <select name="instituicao_id" required>
      <option value="">Selecione um banco</option>
      {instituicoes.map(inst => (
        <option key={inst.id} value={inst.id}>
          {inst.nome_fantasia}
        </option>
      ))}
    </select>
  )
}
```

---

### Caso 4: Polling de Status (para opera√ß√µes longas)

```tsx
// Para casos onde N8N demora muito, pode implementar polling
// (Avan√ßado - s√≥ se necess√°rio)

async function cadastrarComPolling(dados: any) {
  // 1. Iniciar cadastro
  const { data } = await supabase.functions.invoke('cadastrar_recebedor', { body: dados })
  
  if (data.status === 'success') {
    return { sucesso: true }
  }

  // 2. Se falhou mas tem recebedor_id, fazer polling
  if (data.data?.recebedor_id) {
    const recebedorId = data.data.recebedor_id
    
    // Tentar novamente a cada 5 segundos (m√°ximo 3 tentativas)
    for (let i = 0; i < 3; i++) {
      await new Promise(resolve => setTimeout(resolve, 5000))
      
      const retry = await supabase.functions.invoke('ativar_recebedor', {
        body: { recebedor_id: recebedorId }
      })
      
      if (retry.data?.status === 'success') {
        return { sucesso: true }
      }
    }
  }

  return { sucesso: false, erro: data.message }
}
```

---

## üìù Notas Importantes

1. **Autentica√ß√£o Obrigat√≥ria** üîê
   - **Todas** as APIs (RPC e Edge Functions) exigem usu√°rio autenticado
   - O Supabase client passa automaticamente o token no header `Authorization`
   - Exemplo: `const supabase = createClient(...)` com sess√£o ativa
   - Sem autentica√ß√£o: APIs retornar√£o erro 401 (Unauthorized)

2. **Cria√ß√£o/Ativa√ß√£o via Edge Function**
   - As APIs RPC s√£o apenas para **consulta** (r√°pidas, s√≠ncronas)
   - Criar/trocar/reativar recebedor usa **Edge Function** (integra com Pluggy via N8N)

3. **CPF/CNPJ e Nome**
   - S√£o obtidos automaticamente da tabela `assinante`
   - Frontend **N√ÉO** deve enviar esses dados nas Edge Functions

4. **Normaliza√ß√£o de Ag√™ncia/Conta**
   - Backend remove automaticamente caracteres n√£o num√©ricos
   - Frontend pode enviar "0001-9" que ser√° salvo como "00019"
   - Mesma normaliza√ß√£o em valida√ß√£o local e backend

5. **Isolamento Multi-tenant**
   - Todas as APIs filtram automaticamente por `assinante_id`
   - N√£o √© necess√°rio passar `assinante_id` como par√¢metro
   - Cada assinante s√≥ v√™ seus pr√≥prios recebedores

6. **Formato de Resposta**
   - **RPC**: Sempre verificar `data.status === 'OK'` antes de usar `data.data`
   - **Edge Functions**: Verificar `data.status === 'success'`
   - Dados sempre em `data.data.*`, nunca no primeiro n√≠vel

7. **Retry Autom√°tico**
   - Se `cadastrar_recebedor` falhar ao integrar com Pluggy, retorna `recebedor_id`
   - Use `ativar_recebedor` com esse ID para tentar novamente
   - N√£o √© necess√°rio recriar o recebedor

8. **Reativa√ß√£o Inteligente**
   - `ativar_recebedor` detecta se recebedor j√° tem `id_recebedor_gateway`
   - Se tem: Apenas ativa (n√£o chama Pluggy)
   - Se n√£o tem: Tenta cadastrar na Pluggy novamente (retry)

9. **Troca de Conta Ativa**
   - Ao ativar um recebedor, o sistema **automaticamente** inativa o anterior
   - N√£o √© necess√°rio chamar fun√ß√£o separada para inativar

---

## üöÄ Checklist de Implementa√ß√£o

### Backend (‚úÖ Completo)
- ‚úÖ Tabela `gateway_assinante_recebedor` criada
- ‚úÖ Fun√ß√µes `app_internal` implementadas
- ‚úÖ APIs RPC p√∫blicas criadas
- ‚úÖ Edge Function `cadastrar_recebedor` implementada
- ‚úÖ Edge Function `ativar_recebedor` implementada

### Frontend (‚è≥ A fazer)
- [ ] P√°gina de configura√ß√£o de recebimento
- [ ] Formul√°rio de cadastro com valida√ß√£o local
- [ ] Componente de hist√≥rico de contas
- [ ] Bot√£o de reativar conta
- [ ] Tratamento de retry em caso de erro
- [ ] Feedback visual de loading/sucesso/erro

### Infraestrutura (‚è≥ A fazer)
- [ ] Configurar vari√°veis no Supabase:
  - [ ] `SUPABASE_URL`
  - [ ] `SUPABASE_ANON_KEY`
  - [ ] `SUPABASE_SERVICE_ROLE_KEY`
  - [ ] `N8N_CADASTRAR_RECEBEDOR_URL`
  - [ ] `N8N_API_KEY`
- [ ] Criar workflow N8N `cadastrarRecebedor`
- [ ] Deploy das Edge Functions no Supabase
- [ ] Testar fluxo completo em ambiente de desenvolvimento

---

## üìö Recursos Adicionais

- [Planejamento Gest√£o Recebedores](../../../docs/backend/Fase%202/PLANEJAMENTO_GESTAO_RECEBEDORES.md)
- [Integra√ß√£o N8N + Pluggy](../../../docs/backend/Fase%201/INTEGRACAO_N8N_PLUGGY.md)
- [Pluggy Payment Recipient API](https://docs.pluggy.ai/reference/payment-recipient-create)
- [Supabase Edge Functions](https://supabase.com/docs/guides/functions)

