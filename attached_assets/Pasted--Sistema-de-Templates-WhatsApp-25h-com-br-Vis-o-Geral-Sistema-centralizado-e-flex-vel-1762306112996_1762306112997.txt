# Sistema de Templates WhatsApp - 25h.com.br

## ğŸ“‹ VisÃ£o Geral

Sistema centralizado e flexÃ­vel de envio de mensagens WhatsApp com templates dinÃ¢micos armazenados no banco de dados, substituiÃ§Ã£o automÃ¡tica de placeholders e integraÃ§Ã£o via N8N.

## ğŸ¯ Objetivos

- **CentralizaÃ§Ã£o**: Uma Ãºnica Edge Function para todas as mensagens WhatsApp
- **Flexibilidade**: Templates editÃ¡veis sem necessidade de deploy
- **Multi-tenant**: Isolamento perfeito - cada assinante pode personalizar seus templates
- **AutomaÃ§Ã£o**: ExtraÃ§Ã£o automÃ¡tica de placeholders dos templates
- **Escalabilidade**: FÃ¡cil adicionar novos tipos de mensagem

## ğŸ—ï¸ Arquitetura

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Trigger / Frontend  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ {contexto, tipo, data}
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Edge Function: enviar-mensagem-whatsappâ”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. Valida payload                       â”‚
â”‚ 2. Busca template no banco              â”‚
â”‚    (contexto: saas ou assinante)        â”‚
â”‚ 3. Extrai e substitui {{placeholders}}  â”‚
â”‚ 4. Formata payload para N8N             â”‚
â”‚ 5. Envia POST para N8N                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ {whats_assinante, mensagem, tipo}
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ N8N Webhook         â”‚
â”‚ /webhook/enviarMsg  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ WhatsApp            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“Š Estrutura de Dados

### Tabela: `app_data.template_whatsapp_saas`

Templates do sistema (mensagens institucionais).

```sql
CREATE TABLE app_data.template_whatsapp_saas (
  tipo TEXT PRIMARY KEY,                    -- 'boas_vindas', 'cobranca_vencendo', etc
  nome TEXT NOT NULL,                       -- Nome amigÃ¡vel para UI
  template_markdown TEXT NOT NULL,          -- Mensagem com {{placeholders}}
  criado_por UUID REFERENCES auth.users(id),
  criado_em TIMESTAMPTZ DEFAULT now(),
  modificado_em TIMESTAMPTZ DEFAULT now()
);
```

**CaracterÃ­sticas:**
- Chave primÃ¡ria: `tipo` (slug Ãºnico)
- Sem campo `ativo` (nÃ£o precisa histÃ³rico)
- Placeholders extraÃ­dos automaticamente do `template_markdown`
- Suporta Markdown e emojis

### Tabela: `app_data.template_whatsapp_assinante`

Templates personalizados por assinante.

```sql
CREATE TABLE app_data.template_whatsapp_assinante (
  assinante_id UUID NOT NULL REFERENCES app_data.assinante(id) ON DELETE CASCADE,
  tipo TEXT NOT NULL,
  nome TEXT NOT NULL,
  template_markdown TEXT NOT NULL,
  criado_por UUID REFERENCES auth.users(id),
  criado_em TIMESTAMPTZ DEFAULT now(),
  modificado_em TIMESTAMPTZ DEFAULT now(),
  PRIMARY KEY (assinante_id, tipo)
);
```

**CaracterÃ­sticas:**
- Chave primÃ¡ria composta: `(assinante_id, tipo)`
- Isolamento por tenant via RLS
- Cada assinante pode ter template customizado para cada `tipo`

## ğŸ” Row Level Security (RLS)

### Templates SAAS

```sql
-- Apenas admins podem gerenciar (via ind_admin = true)
CREATE POLICY "admins_podem_ler_templates_saas"
  ON app_data.template_whatsapp_saas
  FOR SELECT TO authenticated
  USING (
    EXISTS (
      SELECT 1 FROM app_data.usuario u
      WHERE u.id = auth.uid() AND u.ind_admin = true
    )
  );
```

### Templates Assinante

```sql
-- Assinante vÃª apenas seus prÃ³prios templates
CREATE POLICY "assinante_ve_proprios_templates"
  ON app_data.template_whatsapp_assinante
  FOR SELECT TO authenticated
  USING (assinante_id = app_internal.current_assinante_id());
```

## ğŸ”§ FunÃ§Ãµes DisponÃ­veis

### FunÃ§Ãµes `app_internal` (CRUD)

#### Templates SAAS
- `fn_template_whatsapp_saas_criar(tipo, nome, template_markdown)`
- `fn_template_whatsapp_saas_ler(tipo)`
- `fn_template_whatsapp_saas_atualizar(tipo, nome?, template_markdown?)`
- `fn_template_whatsapp_saas_excluir(tipo)`
- `fn_template_whatsapp_saas_listar(tipo?, nome?)`

#### Templates Assinante
- `fn_template_whatsapp_assinante_criar(assinante_id, tipo, nome, template_markdown)`
- `fn_template_whatsapp_assinante_ler(assinante_id, tipo)`
- `fn_template_whatsapp_assinante_atualizar(assinante_id, tipo, nome?, template_markdown?)`
- `fn_template_whatsapp_assinante_excluir(assinante_id, tipo)`
- `fn_template_whatsapp_assinante_listar(assinante_id, tipo?, nome?)`

#### Helper
- `fn_template_extrair_placeholders(template_markdown)` â†’ Retorna `TEXT[]`
  - Extrai todos os `{{placeholders}}` de um template
  - Exemplo: `"OlÃ¡ {{nome}}, valor {{valor}}"` â†’ `["nome", "valor"]`
- `fn_slugify(texto)` â†’ Retorna `TEXT`
  - Converte texto em slug vÃ¡lido (tipo)
  - Remove acentos, converte para lowercase, substitui espaÃ§os por `_`
  - Exemplo: `"CobranÃ§as Vencendo!!!"` â†’ `"cobrancas_vencendo"`
- `fn_garantir_tipo_unico_saas(slug_base)` â†’ Retorna `TEXT`
  - Garante tipo Ãºnico para templates SAAS, adiciona sufixo se necessÃ¡rio
  - Exemplo: se `"boas_vindas"` existe â†’ `"boas_vindas_2"`
- `fn_garantir_tipo_unico_assinante(assinante_id, slug_base)` â†’ Retorna `TEXT`
  - Garante tipo Ãºnico para templates do assinante, adiciona sufixo se necessÃ¡rio

### FunÃ§Ãµes `public` (API Frontend)

#### Para Assinantes (authenticated)
- `listar_templates_whatsapp(tipo?, nome?)` â†’ Retorna templates com placeholders extraÃ­dos
- `obter_template_whatsapp(tipo)` â†’ Retorna `{status, message, data}`
- `criar_template_whatsapp(nome, template_markdown)` â†’ **Tipo Ã© gerado automaticamente** via slugify
- `atualizar_template_whatsapp(tipo, nome?, template_markdown?)`
- `excluir_template_whatsapp(tipo)`

#### Para Admins (ind_admin = true)
- `criar_template_whatsapp_saas(nome, template_markdown)` â†’ **Tipo Ã© gerado automaticamente** via slugify
- `atualizar_template_whatsapp_saas(tipo, nome?, template_markdown?)`
- `excluir_template_whatsapp_saas(tipo)`
- `listar_templates_whatsapp_saas(tipo?, nome?)`

**PadrÃ£o de Resposta:**
```json
{
  "status": "OK" | "ERROR",
  "message": "Mensagem descritiva",
  "code": "ERROR_CODE",  // Apenas em caso de erro
  "data": {
    "tipo": "boas_vindas",
    "placeholders": ["nome", "whats", "link_video"],
    "total_placeholders": 3
  }
}
```

## ğŸ”„ GeraÃ§Ã£o AutomÃ¡tica de Tipo (Slugify)

O campo `tipo` Ã© **gerado automaticamente** a partir do `nome` do template usando a funÃ§Ã£o `fn_slugify()`. O usuÃ¡rio **nÃ£o precisa informar** o tipo manualmente.

### Como Funciona

1. **UsuÃ¡rio informa apenas `nome` e `template_markdown`**
2. **Sistema gera o `tipo` automaticamente:**
   - Remove acentos: `"CobranÃ§a"` â†’ `"Cobranca"`
   - Converte para lowercase: `"Cobranca"` â†’ `"cobranca"`
   - Substitui espaÃ§os/hÃ­fens por underscore: `"Cobranca Vencendo"` â†’ `"cobranca_vencendo"`
   - Remove caracteres especiais: `"CobranÃ§a!!!"` â†’ `"cobranca"`
   - Garante inÃ­cio com letra e tamanho mÃ­nimo/mÃ¡ximo
3. **Garante unicidade:** Se jÃ¡ existe, adiciona sufixo numÃ©rico (`_2`, `_3`, etc)

### Regras Aplicadas

- âœ… **Apenas lowercase**: caracteres `a-z`
- âœ… **NÃºmeros**: `0-9` permitidos
- âœ… **Separadores**: underscore `_` (normalizado)
- âœ… **Deve comeÃ§ar com letra**: prefixo `t_` adicionado se necessÃ¡rio
- âœ… **Comprimento**: mÃ­nimo 3, mÃ¡ximo 64 caracteres
- âœ… **Unicidade garantida**: sufixo `_N` se tipo jÃ¡ existe

### Exemplos de GeraÃ§Ã£o

**Entrada (nome) â†’ SaÃ­da (tipo):**
- `"Boas Vindas"` â†’ `"boas_vindas"`
- `"CobranÃ§a Vencendo!!!"` â†’ `"cobranca_vencendo"`
- `"Lembrete de Aula 01"` â†’ `"lembrete_de_aula_01"`
- `"   Teste   EspaÃ§os   "` â†’ `"teste_espacos"`
- `"123 Teste"` â†’ `"t_123_teste"` (prefixo `t_` adicionado)
- `"Boas Vindas"` (duplicado) â†’ `"boas_vindas_2"`

### ImplementaÃ§Ã£o

```sql
-- Frontend chama funÃ§Ã£o pÃºblica apenas com nome e template
SELECT public.criar_template_whatsapp_saas(
  'Boas Vindas',  -- nome (entrada do usuÃ¡rio)
  'OlÃ¡ {{nome}}!' -- template
);

-- Backend gera tipo automaticamente
-- Resultado: tipo = "boas_vindas"
```

### FunÃ§Ãµes Internas

- `fn_slugify(texto)` â†’ Converte texto para slug vÃ¡lido
- `fn_garantir_tipo_unico_saas(slug)` â†’ Garante unicidade (SAAS)
- `fn_garantir_tipo_unico_assinante(assinante_id, slug)` â†’ Garante unicidade (Assinante)

---

## ğŸ“ Uso de Placeholders

### Sintaxe

Placeholders usam sintaxe mustache: `{{nome_do_campo}}`

### Exemplo de Template

```markdown
ğŸ‰ OlÃ¡ {{nome}}, bem-vindo(a) Ã  plataforma 25h!

Estamos muito felizes em tÃª-lo(a) conosco. Assista este vÃ­deo:
{{link_video}}

Valor da assinatura: R$ {{valor}}
Vencimento: {{vencimento}}

Qualquer dÃºvida, estamos Ã  disposiÃ§Ã£o! ğŸš€
```

**Placeholders extraÃ­dos automaticamente:** `["nome", "link_video", "valor", "vencimento"]`

### ValidaÃ§Ã£o AutomÃ¡tica

As funÃ§Ãµes pÃºblicas:
1. Extraem placeholders do template via regex: `/\{\{(\w+)\}\}/g`
2. Validam se template contÃ©m pelo menos um placeholder
3. Retornam lista de placeholders na resposta
4. Edge Function valida se `data` contÃ©m todos os placeholders necessÃ¡rios

## ğŸš€ Edge Function (FASE 2 - PrÃ³xima)

### Payload de Entrada

```typescript
{
  contexto: 'saas' | 'assinante',
  assinante_id?: string,  // ObrigatÃ³rio se contexto = 'assinante'
  tipo: string,           // Ex: 'boas_vindas'
  whats: string,          // WhatsApp destinatÃ¡rio (obrigatÃ³rio)
  data: {                 // Dados do template (placeholders)
    [key: string]: any    // Campos conforme template
  }
}
```

### Payload Enviado ao N8N

```json
{
  "whats_assinante": "5551991263303",
  "nome_assinante": "Netto",
  "mensagem": "<texto formatado com emojis>",
  "tipo": "boas_vindas"
}
```

## ğŸ¯ Trigger de Boas-Vindas (FASE 3 - CONCLUÃDA âœ…)

Trigger automÃ¡tico que dispara mensagem de boas-vindas quando novo assinante Ã© criado.

### ğŸ“‹ PrÃ©-requisitos

1. **ExtensÃ£o pg_net instalada:**
```sql
CREATE EXTENSION IF NOT EXISTS pg_net;
```

2. **ParÃ¢metros de configuraÃ§Ã£o criados na tabela `cfg_parametros`:**
   - `SUPABASE_URL` - URL do projeto Supabase
   - `SUPABASE_SERVICE_ROLE_KEY` - Chave service_role para autenticaÃ§Ã£o

3. **Template `boas_vindas` criado** na tabela `template_whatsapp_saas`
4. **ParÃ¢metro `VIDEO_BOAS_VINDAS`** configurado em `cfg_parametros`
5. **Edge Function deployada** (`enviar-mensagem-whatsapp`)

### ğŸ”§ InstalaÃ§Ã£o

Execute o script no SQL Editor:
```bash
supabase/db_functions/triggers/configurar_ambiente.sql  # Configurar variÃ¡veis
supabase/db_functions/triggers/trg_assinante_boas_vindas.sql  # Criar trigger
```

### ğŸš€ Como Funciona

1. **Novo assinante criado** â†’ Trigger dispara automaticamente
2. **Valida WhatsApp** â†’ Se vazio, nÃ£o envia (sem erro)
3. **Busca configuraÃ§Ãµes (da tabela `cfg_parametros`):**
   - URL do Supabase (`SUPABASE_URL`)
   - Service Role Key (`SUPABASE_SERVICE_ROLE_KEY`)
   - Parte variÃ¡vel do link do YouTube (`VIDEO_BOAS_VINDAS`)
4. **Monta payload:**
   ```json
   {
     "contexto": "saas",
     "tipo": "boas_vindas",
     "whats": "5551991263303",
     "data": {
       "nome": "JoÃ£o Silva",
       "link_video": "https://youtu.be/dQw4w9WgXcQ"
     }
   }
   ```
5. **Envia via pg_net** â†’ Edge Function â†’ N8N â†’ WhatsApp
6. **Fire-and-forget** â†’ Erros nÃ£o bloqueiam criaÃ§Ã£o do assinante

### ğŸ§ª Teste

Execute o script de teste:
```bash
cd tests
node test-trigger-boas-vindas.mjs
```

O teste:
- âœ… Verifica prÃ©-requisitos (template, parÃ¢metro)
- âœ… Cria assinante de teste
- âœ… Monitora requisiÃ§Ã£o pg_net
- âœ… Remove assinante apÃ³s confirmaÃ§Ã£o

### ğŸ“Š Monitoramento

**Verificar requisiÃ§Ãµes pg_net:**
```sql
-- Ãšltimas requisiÃ§Ãµes
SELECT id, created, status_code, content::text
FROM net._http_response
WHERE url LIKE '%enviar-mensagem-whatsapp%'
ORDER BY created DESC
LIMIT 10;

-- RequisiÃ§Ãµes pendentes
SELECT *
FROM net.http_request_queue
WHERE url LIKE '%enviar-mensagem-whatsapp%';
```

**Verificar logs da funÃ§Ã£o:**
```sql
-- Logs do PostgreSQL mostrarÃ£o NOTICE/WARNING
-- Exemplo de log de sucesso:
-- NOTICE: [BOAS-VINDAS] Mensagem agendada para assinante JoÃ£o Silva (5551991263303): request_id=123
```

### âš ï¸ Notas Importantes

- **AssÃ­ncrono:** O envio Ã© agendado via pg_net (nÃ£o bloqueia INSERT)
- **Resiliente:** Falhas no envio NÃƒO impedem criaÃ§Ã£o do assinante
- **Logs:** Use NOTICE/WARNING para debug no PostgreSQL
- **SeguranÃ§a:** `SUPABASE_SERVICE_ROLE_KEY` autentica via `Authorization: Bearer` (padrÃ£o Supabase)
- **ConfiguraÃ§Ã£o:** Usa tabela `cfg_parametros` (compatÃ­vel com Supabase managed)

## ğŸ“‹ Templates Iniciais

### boas_vindas (SAAS)

```markdown
ğŸ‰ OlÃ¡, {{nome}}! Bem-vindo(a) Ã  plataforma 25h!

Estamos muito felizes em tÃª-lo(a) conosco. Assista este vÃ­deo rÃ¡pido para comeÃ§ar:
{{link_video}}

Qualquer dÃºvida, estamos Ã  disposiÃ§Ã£o! ğŸš€
```

**Placeholders:** `nome`, `link_video`

## ğŸ§ª Testes

### Scripts SMOKE DisponÃ­veis

#### 1. `tests/test-templates-whatsapp-assinante.mjs`

Testa templates de assinante (usuÃ¡rio comum):
- âœ… Criar template
- âœ… Obter template
- âœ… Atualizar template
- âœ… Listar templates
- âœ… ValidaÃ§Ãµes (duplicado, sem placeholders)
- âœ… Excluir template

**ExecuÃ§Ã£o:**
```bash
cd tests
node test-templates-whatsapp-assinante.mjs
```

#### 2. `tests/test-templates-whatsapp-saas.mjs`

Testa templates SAAS (requer admin):
- âœ… Criar template SAAS
- âœ… Atualizar template SAAS
- âœ… Listar templates SAAS
- âœ… ValidaÃ§Ãµes
- âœ… Excluir template SAAS

**Requisito:** UsuÃ¡rio deve ter `ind_admin = true` na tabela `usuario`

**ExecuÃ§Ã£o:**
```bash
cd tests
node test-templates-whatsapp-saas.mjs
```

#### 3. `tests/test-trigger-boas-vindas.mjs`

Testa trigger automÃ¡tico de boas-vindas:
- âœ… Verifica prÃ©-requisitos (pg_net, template, parÃ¢metro)
- âœ… Cria assinante teste (dispara trigger)
- âœ… Monitora requisiÃ§Ã£o pg_net
- âœ… OpÃ§Ã£o de limpeza do assinante teste

**Requisitos:**
- pg_net instalado
- VariÃ¡veis de ambiente configuradas
- Template e parÃ¢metro existentes

**ExecuÃ§Ã£o:**
```bash
cd tests
node test-trigger-boas-vindas.mjs
```

## ğŸ“¦ InstalaÃ§Ã£o

### 1. Aplicar DDL no Supabase

Execute o conteÃºdo do arquivo `criar_templates_whatsapp.sql` no SQL Editor do Supabase Dashboard.

### 2. Aplicar FunÃ§Ãµes CRUD

Aplique no SQL Editor (na ordem):
1. `supabase/db_functions/app_internal/templates_whatsapp/crud_templates_saas.sql`
2. `supabase/db_functions/app_internal/templates_whatsapp/crud_templates_assinante.sql`

### 3. Aplicar FunÃ§Ãµes PÃºblicas

Aplique no SQL Editor:
1. `supabase/db_functions/public/templates_whatsapp/listar_templates_whatsapp.sql`
2. `supabase/db_functions/public/templates_whatsapp/obter_template_whatsapp.sql`
3. `supabase/db_functions/public/templates_whatsapp/criar_template_whatsapp.sql`
4. `supabase/db_functions/public/templates_whatsapp/atualizar_template_whatsapp.sql`
5. `supabase/db_functions/public/templates_whatsapp/excluir_template_whatsapp.sql`
6. `supabase/db_functions/public/templates_whatsapp/criar_template_whatsapp_saas.sql` (funÃ§Ãµes para admins)

### 4. Instalar ExtensÃ£o pg_net

```sql
CREATE EXTENSION IF NOT EXISTS pg_net;
```

### 5. Configurar ParÃ¢metros do Sistema

Execute no SQL Editor (edite com seus valores reais antes):
```bash
supabase/db_functions/triggers/configurar_ambiente.sql
```

**IMPORTANTE:** 
- Use a mesma `SUPABASE_SERVICE_ROLE_KEY` que estÃ¡ nas env vars da Edge Function
- Substitua `SUPABASE_URL` pela URL do seu projeto
- O script usa UPSERT (pode re-executar sem problemas)

### 6. Configurar ParÃ¢metro VIDEO_BOAS_VINDAS

```sql
-- Execute no SQL Editor (substitua pelo ID real do vÃ­deo)
SELECT app_internal.fn_cfg_parametros_criar(
  'VIDEO_BOAS_VINDAS',
  'dQw4w9WgXcQ',  -- Parte variÃ¡vel do link (apÃ³s https://youtu.be/)
  'Link do vÃ­deo de boas-vindas para novos assinantes',
  'WHATSAPP'
);
```

### 7. Criar Trigger de Boas-Vindas

Execute no SQL Editor:
```bash
supabase/db_functions/triggers/trg_assinante_boas_vindas.sql
```

### 8. Rodar Testes

```bash
cd tests
npm install
node test-templates-whatsapp-assinante.mjs   # Templates assinante
node test-templates-whatsapp-saas.mjs        # Templates SAAS (admin)
node test-trigger-boas-vindas.mjs            # Trigger automÃ¡tico
```

## ğŸ”® Casos de Uso Futuros

Este sistema suporta facilmente:
- âœ‰ï¸ CobranÃ§as vencendo
- ğŸ‚ Mensagens de aniversÃ¡rio
- â° Lembretes de agendamento
- âœ… ConfirmaÃ§Ãµes de pagamento
- âŒ Cancelamentos
- ğŸ“Š RelatÃ³rios mensais
- ğŸ PromoÃ§Ãµes
- ğŸ”” NotificaÃ§Ãµes personalizadas por assinante

## âœ… Status Atual - TODAS AS FASES CONCLUÃDAS! ğŸ‰

### **FASE 1 - CONCLUÃDA** âœ…
- [x] Tabelas criadas (`template_whatsapp_saas`, `template_whatsapp_assinante`)
- [x] RLS configurado (isolamento por assinante)
- [x] FunÃ§Ãµes CRUD implementadas (app_internal)
- [x] FunÃ§Ãµes pÃºblicas implementadas (public schema)
- [x] Template inicial de boas-vindas
- [x] Scripts SMOKE test funcionais
- [x] ValidaÃ§Ã£o automÃ¡tica de placeholders
- [x] GeraÃ§Ã£o automÃ¡tica de tipo (slugify)
- [x] DocumentaÃ§Ã£o completa

### **FASE 2 - CONCLUÃDA** âœ…
- [x] Edge Function `enviar-mensagem-whatsapp` criada
- [x] Suporte a templates SAAS e Assinante
- [x] SubstituiÃ§Ã£o automÃ¡tica de placeholders
- [x] ValidaÃ§Ã£o de payload e campos obrigatÃ³rios
- [x] IntegraÃ§Ã£o com N8N via webhook
- [x] AutenticaÃ§Ã£o por JWT (frontend) e secret (interno)
- [x] PadrÃ£o de resposta unificado
- [x] Tratamento robusto de erros
- [x] Scripts de teste

### **FASE 3 - CONCLUÃDA** âœ…
- [x] ExtensÃ£o pg_net configurada
- [x] Trigger `trg_assinante_boas_vindas` criado
- [x] FunÃ§Ã£o `fn_notificar_boas_vindas()` implementada
- [x] ConfiguraÃ§Ã£o de variÃ¡veis de ambiente (PostgreSQL)
- [x] IntegraÃ§Ã£o com parÃ¢metro `VIDEO_BOAS_VINDAS`
- [x] Envio assÃ­ncrono via pg_net (fire-and-forget)
- [x] Tratamento de erros (nÃ£o bloqueia INSERT)
- [x] Script de teste da trigger
- [x] DocumentaÃ§Ã£o de monitoramento

## ğŸ”® PrÃ³ximos Passos (Futuro)

Este sistema estÃ¡ **pronto para produÃ§Ã£o** e pode ser facilmente expandido para:
- âœ‰ï¸ **CobranÃ§as vencendo** â†’ Criar template + trigger em assinatura_cobranca
- ğŸ‚ **AniversÃ¡rios** â†’ Criar template + job agendado (N8N)
- â° **Lembretes de agendamento** â†’ Criar template + trigger em evento
- âœ… **ConfirmaÃ§Ãµes de pagamento** â†’ Criar template + webhook
- âŒ **Cancelamentos** â†’ Criar template + trigger
- ğŸ“Š **RelatÃ³rios mensais** â†’ Criar template + job agendado
- ğŸ **PromoÃ§Ãµes** â†’ Criar template + envio manual/programado

## ğŸ’¡ ObservaÃ§Ãµes TÃ©cnicas

- Templates mantÃªm **Markdown e emojis** intactos
- Placeholders no formato `{{campo}}` (mustache-like)
- ExtraÃ§Ã£o via regex: `/\{\{(\w+)\}\}/g`
- N8N recebe mensagem jÃ¡ formatada (pronta para enviar)
- Falhas no envio nÃ£o interrompem criaÃ§Ã£o de assinante (fire-and-forget)
- RLS garante isolamento de templates entre assinantes
- ValidaÃ§Ã£o de placeholders em tempo de criaÃ§Ã£o/atualizaÃ§Ã£o
